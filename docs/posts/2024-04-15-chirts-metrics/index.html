<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Finn Roberts">
<meta name="dcterms.date" content="2024-04-15">
<meta name="description" content="Generalize your code to more easily aggregate time-varying environmental data">
<title>Flexible Workflows with CHIRTS Temperature Data – IPUMS DHS Spatial Analysis and Health Research Hub</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon/favicon-32x32.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0WLH5S9VD5"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0WLH5S9VD5', { 'anonymize_ip': true});
</script>
<meta property="og:title" content="Reproducible Workflows with CHIRTS Temperature Data">
<meta property="og:description" content="Build flexibile workflows to more easily aggregate time-varying environmental data">
<meta property="og:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-04-15-chirts-metrics/index_files/figure-html/listing-img-1.png">
<meta property="og:site_name" content="IPUMS DHS Spatial Analysis and Health Research Hub">
<meta property="og:image:height" content="1536">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="Reproducible Workflows with CHIRTS Temperature Data">
<meta name="twitter:description" content="Build flexibile workflows to more easily aggregate time-varying environmental data">
<meta name="twitter:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-04-15-chirts-metrics/index_files/figure-html/listing-img-1.png">
<meta name="twitter:image-height" content="1536">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://www.idhsdata.org/idhs/" class="navbar-brand navbar-brand-logo">
    <img src="../../images/dhs_logo_white.png" alt="" class="navbar-logo"></a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Spatial Analysis and Health Research Hub</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-getting-started" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Getting Started</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-getting-started">
<li>
    <a class="dropdown-item" href="../../posts/2024-02-01-getting-started-with-r/index.html">
 <span class="dropdown-text">An Introduction to R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/2024-02-02-download-dhs-data/index.html">
 <span class="dropdown-text">Obtaining IPUMS DHS Data</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-community" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Community</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-community">
<li>
    <a class="dropdown-item" href="https://forum.ipums.org">
 <span class="dropdown-text">IPUMS Forum</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../CODE_OF_CONDUCT.html">
 <span class="dropdown-text">Code of Conduct</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../LICENSE.html">
 <span class="dropdown-text">License</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/ipums/dhs-research-hub"> 
<span class="menu-text"><i class="fa-brands fa-github" aria-label="github"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml"> 
<span class="menu-text"><i class="fa-solid fa-rss" aria-label="rss"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://twitter.com/ipumsGH"> 
<span class="menu-text"><i class="fa-brands fa-x-twitter" aria-label="x-twitter"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://forum.ipums.org"> 
<span class="menu-text"><i class="fa-solid fa-users" aria-label="users"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.ipums.org/"> 
<span class="menu-text"><i class="fa-solid fa-globe" aria-label="globe"></i></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Flexible Workflows with CHIRTS Temperature Data</h1>
                  <div>
        <div class="description">
          <p>Generalize your code to more easily aggregate time-varying environmental data</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">CHIRTS</div>
                <div class="quarto-category">Temperature</div>
                <div class="quarto-category">Heat</div>
                <div class="quarto-category">Extreme weather</div>
                <div class="quarto-category">Time series</div>
                <div class="quarto-category">Reproducible workflows</div>
                <div class="quarto-category">Functional programming</div>
                <div class="quarto-category">terra</div>
                <div class="quarto-category">sf</div>
                <div class="quarto-category">ggspatial</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Finn Roberts </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Senior Data Analyst, IPUMS
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#a-new-approach" id="toc-a-new-approach" class="nav-link active" data-scroll-target="#a-new-approach">A new approach</a></li>
  <li>
<a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a>
  <ul class="collapse">
<li><a href="#dhs-boundaries" id="toc-dhs-boundaries" class="nav-link" data-scroll-target="#dhs-boundaries">DHS boundaries</a></li>
  <li>
<a href="#chirts" id="toc-chirts" class="nav-link" data-scroll-target="#chirts">CHIRTS</a>
  <ul class="collapse">
<li><a href="#manual-download" id="toc-manual-download" class="nav-link" data-scroll-target="#manual-download">Manual download</a></li>
  <li><a href="#access-via-the-chirps-package" id="toc-access-via-the-chirps-package" class="nav-link" data-scroll-target="#access-via-the-chirps-package">Access via the chirps package</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#calculating-monthly-temperature-metrics" id="toc-calculating-monthly-temperature-metrics" class="nav-link" data-scroll-target="#calculating-monthly-temperature-metrics">Calculating monthly temperature metrics</a>
  <ul class="collapse">
<li><a href="#average-monthly-temperature" id="toc-average-monthly-temperature" class="nav-link" data-scroll-target="#average-monthly-temperature">1. Average monthly temperature</a></li>
  <li>
<a href="#days-above" id="toc-days-above" class="nav-link" data-scroll-target="#days-above">2. Days above a temperature threshold</a>
  <ul class="collapse">
<li><a href="#logical-raster-operations" id="toc-logical-raster-operations" class="nav-link" data-scroll-target="#logical-raster-operations">Logical raster operations</a></li>
  </ul>
</li>
  <li>
<a href="#heatwaves-consecutive-days-above-a-temperature-threshold" id="toc-heatwaves-consecutive-days-above-a-temperature-threshold" class="nav-link" data-scroll-target="#heatwaves-consecutive-days-above-a-temperature-threshold">3. Heatwaves: Consecutive days above a temperature threshold</a>
  <ul class="collapse">
<li><a href="#custom-functions" id="toc-custom-functions" class="nav-link" data-scroll-target="#custom-functions">Custom functions</a></li>
  <li><a href="#scaling-up" id="toc-scaling-up" class="nav-link" data-scroll-target="#scaling-up">Scaling up</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#up-next" id="toc-up-next" class="nav-link" data-scroll-target="#up-next">Up next</a>
  <ul class="collapse">

  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In our <a href="../2024-02-04-dhs-chirps/index.html">previous technical post</a>, we showed how to reduce a daily time series of environmental data for an entire country into a single digestible metric that can be attached to <a href="https://www.dhsprogram.com/">DHS survey</a> data for use in an analysis.</p>
<p>However, as we mentioned then, a long-run average isn’t always the most appropriate way to aggregate raster values across time. As an example, imagine we were interested in the impacts of <strong>extreme heat</strong> on child <strong>birth weight</strong>. The proximate conditions in the several months preceding each child’s birth are likely to be more consequential for that child’s health than the average conditions over many years.<span class="citation" data-cites="Grace2021"><sup><a href="#ref-Grace2021" role="doc-biblioref">1</a></sup></span></p>
<section id="a-new-approach" class="level1"><h1>A new approach</h1>
<p>To explore this idea, we could instead aggregate temperature data to the a more fine-grained temporal level and selectively consider the temperature in a specified time range before each child’s birth.</p>
<p>Fortunately, DHS surveys do record some temporal information, including the timing of the survey interview as well as birth dates for survey respondents and children. But these details are recorded at the <strong>monthly</strong> level. To account for the uncertainty in the dates reported in DHS surveys, we need to aggregate our CHIRTS data to the monthly level as well.</p>
<p>This approach adds three key dimensions to the techniques introduced in our precipitation post. We need to:</p>
<ol type="1">
<li>calculate a temperature exposure metric at the monthly level</li>
<li>identify the relevant months of temperature data for each child based on their recorded birth month</li>
<li>summarize each child’s temperature exposure using their individual monthly time series of temperature data</li>
</ol>
<p>This post focuses on the first item; our next post in this series will consider the other two. First, we’ll show how to obtain the necessary data for this demonstration, which come from <a href="https://www.idhsdata.org/idhs/">IPUMS DHS</a> and the <a href="https://chc.ucsb.edu/">Climate Hazards Center</a> (CHC). Then, we’ll build on some of the tools and techniques presented in our <a href="../2024-02-04-dhs-chirps/index.html">first technical post</a> to demonstrate several ways to operationalize and calculate temperature exposure at the monthly level.</p>
<p>Before we get started, we’ll load the main packages that we’ll use in this post:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tech.popdata.org/ipumsr/">ipumsr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data-preparation" class="level1 page-columns page-full"><h1>Data preparation</h1>
<section id="dhs-boundaries" class="level2"><h2 class="anchored" data-anchor-id="dhs-boundaries">DHS boundaries</h2>
<p>For this series, we’ll use the 2012 DHS sample for Mali. We won’t be working with the survey data until our next post, but we will be using the integrated administrative boundary files from IPUMS in our maps.</p>
<p>You can download the boundary data directly from IPUMS DHS by clicking the <strong>shapefile</strong> link under the Mali section of <a href="https://www.idhsdata.org/idhs/gis.shtml">this table</a>. We’ve placed this shapefile in the <code>data/gps</code> directory within our project.</p>
<p><a href="../2024-02-04-dhs-chirps/#loading-cluster-coordinates">Previously</a>, we unzipped the shapefile and loaded it with <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read()</a></code> from the sf package. However, since IPUMS often distributes shapefiles in zip archives, ipumsr provides <code><a href="https://tech.popdata.org/ipumsr/reference/read_ipums_sf.html">read_ipums_sf()</a></code> as a way to read a shapefile directly without manually extracting the compressed files. We’ll use this convenience to load our boundary data into an <code>sf</code> object:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_borders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tech.popdata.org/ipumsr/reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="st">"data/gps/geo_ml1995_2018.zip"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ml_borders</span></span>
<span><span class="co">#&gt; Simple feature collection with 8 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -12.23888 ymin: 10.14781 xmax: 4.267383 ymax: 25.00108</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; # A tibble: 8 × 4</span></span>
<span><span class="co">#&gt;   CNTRY_NAME ADMIN_NAME    DHSCODE                                      geometry</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt;           &lt;int&gt;                                 &lt;POLYGON [°]&gt;</span></span>
<span><span class="co">#&gt; 1 Mali       Kayes               1 ((-9.330095 15.50158, -9.320187 15.50138, -9…</span></span>
<span><span class="co">#&gt; 2 Mali       Ségou               4 ((-3.962041 13.50099, -3.963767 13.50299, -3…</span></span>
<span><span class="co">#&gt; 3 Mali       Mopti               5 ((-0.7440053 15.06439, -0.9481987 14.88898, …</span></span>
<span><span class="co">#&gt; 4 Mali       Tombouctou          6 ((-0.005279168 21.87488, -0.006277 21.87317,…</span></span>
<span><span class="co">#&gt; 5 Mali       Bamako              9 ((-7.932848 12.68226, -7.932015 12.68209, -7…</span></span>
<span><span class="co">#&gt; 6 Mali       Sikasso             3 ((-4.472905 12.71992, -4.472977 12.71908, -4…</span></span>
<span><span class="co">#&gt; 7 Mali       Koulikoro           2 ((-9.076561 15.50138, -9.000042 15.50046, -8…</span></span>
<span><span class="co">#&gt; 8 Mali       Gao and Kidal       7 ((-0.4509285 15.0843, -0.450753 15.0864, -0.…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our boundary file includes borders for individual administrative units within Mali. However, it’s often useful to have a single external border for spatial operations and mapping.</p>
<p>To combine internal borders, we can use <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code> from <a href="https://r-spatial.github.io/sf/">sf</a>. However, in this case, we first need to simplify our file so that <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code> works properly.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For some spatial files, small misalignments may cause problems for certain spatial operations. Often, you’ll notice these issues in your maps if errant lines or points appear in unexpected places. You can check whether a file is topologically valid with <code><a href="https://r-spatial.github.io/sf/reference/valid.html">st_is_valid()</a></code>.</p>
</div>
</div>
<p>We use <code><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid()</a></code> to correct some of these issues. Then, we can combine our internal geometries with <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code> and simplify our external border slightly.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Validate internal borders</span></span>
<span><span class="va">ml_borders_neat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="va">ml_borders</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Collapse internal borders to get single country border</span></span>
<span><span class="va">ml_borders_out</span> <span class="op">&lt;-</span> <span class="va">ml_borders_neat</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span>dTolerance <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we have both detailed internal borders as well as a single country border.</p>
</section><section id="chirts" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="chirts">CHIRTS</h2>
<p>For our temperature data, we’ll use the <a href="https://www.chc.ucsb.edu/data/chirtsdaily">Climate Hazards Center Infrared Temperature with Stations</a> (CHIRTS) dataset.<span class="citation" data-cites="Funk2019"><sup><a href="#ref-Funk2019" role="doc-biblioref">2</a></sup></span> CHIRTS provides daily estimates for several temperature metrics at a 0.05° (~5 kilometer) raster resolution. CHIRTS provides estimates of the following measures:</p>
<ul>
<li>Daily maximum air temperature (2 meters above ground)</li>
<li>Daily minimum air temperature (2 meters above ground)</li>
<li>Daily average relative humidity</li>
<li>Daily average heat index</li>
</ul>
<p>The most appropriate metric will depend on the nature of your research. For instance, relevant temperature metrics for studying the effects of heat on the human body are likely different from those used for studying agricultural productivity.</p>
<p>For health research, it’s also worth considering the specifics of the population of interest, as they may employ adaptive strategies or be at increased risk of heat exposure due to common pre-existing conditions or lifestyle features.<span class="citation" data-cites="Vanos2020"><sup><a href="#ref-Vanos2020" role="doc-biblioref">3</a></sup></span></p>
<p>Since this post focuses specifically on R techniques (and not on methodological considerations), we’ll keep it simple and use <strong>daily maximum air temperature</strong>.</p>
<p>There are two ways to go about obtaining the CHIRTS data: either via manual download or via the <a href="https://docs.ropensci.org/chirps/">chirps</a> R package.</p>
<section id="manual-download" class="level3"><h3 class="anchored" data-anchor-id="manual-download">Manual download</h3>
<p>CHIRTS data for Africa can be <a href="http://data.chc.ucsb.edu/products/CHIRTSdaily/v1.0/africa_netcdf_p05/">downloaded directly</a> from the Climate Hazards Center.</p>
<p>Data are distributed as <a href="https://www.unidata.ucar.edu/software/netcdf/">NetCDF</a> files, a common format for distributing scientific raster data structures. NetCDF files contain metadata about the file contents (for instance, about the temporal or spatial dimensions of the data), which will be useful later when we aggregate data to the monthly level.</p>
<p>You’ll notice that the files—each of which contains a full year’s worth of data for the entire continent of Africa—contain 3.3 <em>Giga</em>bytes of data apiece. For this demonstration, we’ll therefore only download a single year of data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Climatological Normals
</div>
</div>
<div class="callout-body-container callout-body">
<p>When dealing with environmental data, it’s often necessary to have a long time series of data to establish a stable <em>climatological normal</em>, or baseline, to which to compare current observations. 30-year normals are commonly used, but their use has recently been questioned due to the acceleration of extreme weather frequency.<span class="citation" data-cites="Livezey2007"><sup><a href="#ref-Livezey2007" role="doc-biblioref">4</a></sup></span></p>
<p>Because of the space and time required to obtain data to calculate normals at a high resolution, we won’t be creating normals from CHIRTS in this post, but you may see them in the literature.</p>
</div>
</div>
<p>We’re working with the 2012 Mali sample from IPUMS DHS for this example, so we’ll download the <code>Tmax.2012.nc</code> file from the <a href="http://data.chc.ucsb.edu/products/CHIRTSdaily/v1.0/africa_netcdf_p05/">CHC listing</a>. We’ve placed this file in the <code>data</code> directory.</p>
<p>Fortunately, we don’t need to learn any new tools to handle this file, as support for NetCDF is already built into <a href="https://rspatial.org/">terra</a>. We can easily load the raster with <code><a href="https://rspatial.github.io/terra/reference/rast.html">rast()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_chirts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"data/Tmax.2012.nc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this post we’ll be particularly interested in the temporal dimension of our raster data. Typically, a raster stack will represent time in layers, where each layer represents the recorded values at a particular point in time. terra’s <code>SpatRaster</code> objects have a built-in representation of time, which can be accessed with the <code><a href="https://rspatial.github.io/terra/reference/time.html">time()</a></code> function:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] "2012-01-01" "2012-01-02" "2012-01-03" "2012-01-04" "2012-01-05"</span></span>
<span><span class="co">#&gt;   [6] "2012-01-06" "2012-01-07" "2012-01-08" "2012-01-09" "2012-01-10"</span></span>
<span><span class="co">#&gt;  [11] "2012-01-11" "2012-01-12" "2012-01-13" "2012-01-14" "2012-01-15"</span></span>
<span><span class="va">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that the temporal information contained in the NetCDF file was automatically included when we loaded this raster into R. Each of these dates correspond to a layer in the <code>SpatRaster</code>. This temporal representation will become useful when we aggregate temperature to the monthly level.</p>
<section id="crop-chirts-raster" class="level4"><h4 class="anchored" data-anchor-id="crop-chirts-raster">Crop CHIRTS raster</h4>
<p>Downloading data from the CHC provides a raster for the entire African continent. We can greatly speed up our future processing by cropping this raster to our area of interest using the Mali borders that we loaded above.</p>
<p>First, we’ll add a 10 kilometer buffer around the country border so that we retain the CHIRTS data just outside of the country as well. That way, if any DHS clusters fall in the border regions of the country, we will still be able to calculate temperature metrics in their general vicinity.</p>
<p>We’ve covered buffering <a href="../2024-02-04-dhs-chirps/#cluster-buffers">in the past</a> if you need to refresh your memory on this process.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Transform to UTM 29N coordinates, buffer, and convert back to WGS84</span></span>
<span><span class="va">ml_borders_buffer</span> <span class="op">&lt;-</span> <span class="va">ml_borders_out</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">32629</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can crop the CHIRTS raster to our buffered border region with terra’s <code><a href="https://rspatial.github.io/terra/reference/crop.html">crop()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_chirts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">ml_chirts</span>, <span class="va">ml_borders_buffer</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="access-via-the-chirps-package" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="access-via-the-chirps-package">Access via the chirps package</h3>
<p>You may recall from our <a href="../2024-02-04-dhs-chirps/#option-2-the-chirps-package">previous technical post</a> that CHC data can be obtained via the <a href="https://docs.ropensci.org/chirps/">chirps</a> package in R. This package provides access to CHIRTS data as well.</p>
<p>You can obtain CHIRTS from the chirps package by providing a spatial boundary representing the area of interest for which the CHIRTS raster data should be obtained. You’ll also need to specify a temporal range and temperature variable.</p>
<p>In this case, we’ll use the buffered administrative borders for Mali that we downloaded earlier, specify the 2012 time range, and select the <code>"Tmax"</code> variable:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_chirts2</span> <span class="op">&lt;-</span> <span class="fu">chirps</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/chirps/reference/get_chirts.html">get_chirts</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">ml_borders_buffer</span><span class="op">)</span>, </span>
<span>  dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2012-01-01"</span>, <span class="st">"2012-12-31"</span><span class="op">)</span>,</span>
<span>  var <span class="op">=</span> <span class="st">"Tmax"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>We convert our administrative borders to a terra <code>SpatVector</code> object with <code><a href="https://rspatial.github.io/terra/reference/vect.html">vect()</a></code> because this is the spatial structure expected by <code>get_chirts()</code>.</p>
</div></div><p>In contrast to the NetCDF files provided when downloading CHIRTS data directly, obtaining data via the chirps package does not provide any temporal metadata:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ml_chirts2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt;  [26] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt;  [51] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="va">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we know that we have a full year of data, we can construct the temporal metadata manually. We’ll use the <a href="https://lubridate.tidyverse.org">lubridate</a> package to make this a little easier:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert strings to Date objects specifying year-month-day (ymd) format:</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-01"</span><span class="op">)</span></span>
<span><span class="va">end</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set time as a daily sequence of dates for all of 2012</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ml_chirts2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, by <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ml_chirts2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] "2012-01-01" "2012-01-02" "2012-01-03" "2012-01-04" "2012-01-05"</span></span>
<span><span class="co">#&gt;   [6] "2012-01-06" "2012-01-07" "2012-01-08" "2012-01-09" "2012-01-10"</span></span>
<span><span class="co">#&gt;  [11] "2012-01-11" "2012-01-12" "2012-01-13" "2012-01-14" "2012-01-15"</span></span>
<span><span class="va">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Manually attaching time units works in this case because we know the CHIRTS data have no gaps. However, there’s no built-in check to ensure that you’re attaching the correct date to each layer of the raster stack, so you’ll want to be sure you know what time units are truly represented by each layer before assigning them manually.</p>
</div>
</div>
<p>At this point, we should have a daily raster for the region around Mali. We can take a peek by mapping the temperature distribution on a single day of our CHIRTS time series:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>We’re not going to explicitly demonstrate how we produce our maps in this post since some are fairly complicated to set up. If you’re curious, you can peek at the collapsed code blocks to see how each of our maps are produced.</p>
</div></div><div class="cell">
<details class="code-fold"><summary>Show plot functions</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add map scale bar and update guides</span></span>
<span><span class="va">theme_dhs_map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">show_scale</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">continuous</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">show_scale</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>, </span>
<span>      text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>      line_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>      height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">scale</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">continuous</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">guide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>      fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colorbar</a></span><span class="op">(</span>draw.llim <span class="op">=</span> <span class="cn">FALSE</span>, draw.ulim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">guide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>      fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_coloursteps.html">guide_colorsteps</a></span><span class="op">(</span>draw.llim <span class="op">=</span> <span class="cn">FALSE</span>, draw.ulim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">scale</span>, <span class="va">guide</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Define custom palette functions so we can easily reproduce</span></span>
<span><span class="co"># color schemes across our maps in this post</span></span>
<span><span class="va">chirts_palettes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#bad3e8"</span>, <span class="st">"#ffd3a3"</span>, <span class="st">"#da5831"</span>, <span class="st">"#872e38"</span><span class="op">)</span>,</span>
<span>    diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#5B3794"</span>, <span class="st">"#8F4D9F"</span>, <span class="st">"#B76AA8"</span>, <span class="st">"#D78CB1"</span>, <span class="st">"#F1B1BE"</span>, <span class="st">"#F8DCD9"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Continuous fill scale for a selected palette</span></span>
<span><span class="va">scale_chirts_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pal</span> <span class="op">=</span> <span class="st">"main"</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">chirts_palettes</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="va">pal</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="va">pal</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># ggplot2 layer for continuous scale for selected palette</span></span>
<span><span class="va">scale_fill_chirts_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pal</span> <span class="op">=</span> <span class="st">"main"</span>, <span class="va">na.value</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">scale_chirts_c</span><span class="op">(</span><span class="va">pal</span><span class="op">)</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu">pal</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="va">na.value</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># ggplot2 layer for binned scale for selected palette</span></span>
<span><span class="va">scale_fill_chirts_b</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pal</span> <span class="op">=</span> <span class="st">"main"</span>, <span class="va">na.value</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">scale_chirts_c</span><span class="op">(</span><span class="va">pal</span><span class="op">)</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_steps.html">scale_fill_stepsn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu">pal</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="va">na.value</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Split raster into two at the country border to allow for differential </span></span>
<span><span class="co"># highlighting</span></span>
<span><span class="va">r_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ml_borders_out</span>, inverse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">r_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ml_borders_out</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">r_in</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">r_out</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_neat</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#eeeeee"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_out</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#7f7f7f"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Daily Maximum Temperature: Mali"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"January 1, 2012"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Temperature (°C)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_chirts_c</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section></section><section id="calculating-monthly-temperature-metrics" class="level1 page-columns page-full"><h1>Calculating monthly temperature metrics</h1>
<p>As we mentioned in the introduction, our ultimate goal is to identify the temperature trends prior to each birth in our DHS sample. However, DHS survey data record temporal information about interviews and births at the <strong>monthly</strong> level. Thus, the most accurate we can be is to identify temperature running up to the <strong>month</strong> immediately prior to a child’s birth.</p>
<p>We therefore need to aggregate our daily CHIRTS data to the monthly level. In the rest of the post, we’ll demonstrate how to calculate several possible monthly metrics in R. Then, in a future post, we’ll demonstrate how to attach the monthly CHIRTS data to each record in our DHS sample.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Defining Heat Exposure
</div>
</div>
<div class="callout-body-container callout-body">
<p>A vast array of methods to identify extreme temperature and heatwave exposure exist in the literature, and we can’t demonstrate the processing required for each and every one. However, the approaches we demonstrate should give you a sense of the tools and techniques available for you when working with temperature data in your own research.</p>
</div>
</div>
<section id="average-monthly-temperature" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="average-monthly-temperature">1. Average monthly temperature</h2>
<p>For our first metric, we’ll take a simple approach and calculate an average monthly temperature.</p>
<p><a href="../2024-02-04-dhs-chirps/#summarize-precipitation-values">Previously</a>, we introduced terra’s <code><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean()</a></code> method, which allows you to calculate a single mean across all layers of a <code>SpatRaster</code> object. In this case, we also want to calculate a mean, but we need to adapt our approach so we can do so for each month independently.</p>
<p>Enter terra’s <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> function. <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> allows you to apply a function to <strong>groups of raster layers</strong>. You can indicate which layers should be grouped together with the <code>index</code> argument. For instance, to independently calculate the mean of the first three layers and the second three layers, we could use the following <code>index</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp</a></span><span class="op">(</span></span>
<span>  <span class="va">ml_chirts</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span>, <span class="co"># Select the first 6 layers to demo</span></span>
<span>  fun <span class="op">=</span> <span class="va">mean</span>, </span>
<span>  index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 301, 335, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.05, 0.05  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -12.35, 4.399999, 10.05, 25.1  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       :       X1,       X2 </span></span>
<span><span class="co">#&gt; min values  : 20.32146, 21.20080 </span></span>
<span><span class="co">#&gt; max values  : 35.77333, 35.86034</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that this produces an output <code>SpatRaster</code> with 2 layers: the first represents the mean of the first 3 layers in the input, and the second represents the mean of the next 3 layers.</p>
<p>However, manually identifying the index layers for each month of the year would be tedious and error-prone. Not only would we have to type out code to handle 366 days of data, but we would also have to contend with the fact that months vary in length. And depending on your time frame and region of interest, you may also need to account for leap years or entirely different calendars!</p>
<p>Fortunately, terra provides us with an easier way. Because we have a <code>time</code> component to our data, we can use the temporal metadata already attached to our raster as the index. For instance, to aggregate by month, simply use <code>index = "months"</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_chirts_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp</a></span><span class="op">(</span><span class="va">ml_chirts</span>, fun <span class="op">=</span> <span class="va">mean</span>, index <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ml_chirts_mean</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 301, 335, 12  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.05, 0.05  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -12.35, 4.399999, 10.05, 25.1  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (CRS84) (OGC:CRS84) </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       :      m_1,      m_2,      m_3,      m_4,      m_5,      m_6, ... </span></span>
<span><span class="co">#&gt; min values  : 20.13009, 21.27224, 27.66812, 29.93578, 29.76501, 26.91157, ... </span></span>
<span><span class="co">#&gt; max values  : 35.44701, 38.60472, 40.72202, 42.85499, 44.10707, 47.46994, ... </span></span>
<span><span class="co">#&gt; time (mnts) : Jan to Dec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, we now have 12 layers in our output <code>SpatRaster</code> (see the <code>dimensions</code> component of the output above). Each layer contains the average daily maximum temperature (in degrees Celsius) for the given month, as shown below.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper to split raster layers into a list for small-multiple panel mapping</span></span>
<span><span class="va">split_raster</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nlyr</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">r</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Function to build individual panels for a small-multiple map using </span></span>
<span><span class="co"># continuous color scheme</span></span>
<span><span class="va">chirts_panel_continuous</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                                    <span class="va">panel_title</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                    <span class="va">show_scale</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">ml_borders_out</span>, inverse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">r_in</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_neat</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#eeeeee"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_out</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#7f7f7f"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="va">panel_title</span>, fill <span class="op">=</span> <span class="st">"Temperature (°C)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_chirts_c</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_dhs_map</span><span class="op">(</span>show_scale <span class="op">=</span> <span class="va">show_scale</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>      axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>      axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Split raster by layer</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">split_raster</span><span class="op">(</span><span class="va">ml_chirts_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show scale only on final panel</span></span>
<span><span class="va">show_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Panel labels</span></span>
<span><span class="va">months</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"January"</span>, <span class="st">"February"</span>, <span class="st">"March"</span>, <span class="st">"April"</span>, </span>
<span>            <span class="st">"May"</span>, <span class="st">"June"</span>, <span class="st">"July"</span>, <span class="st">"August"</span>,</span>
<span>            <span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"November"</span>, <span class="st">"December"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map panels</span></span>
<span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">months</span>, <span class="va">show_scale</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="fu">chirts_panel_continuous</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">panels</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Average Monthly Temperature: Mali 2012"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note that the CHC does provide a <a href="https://chc.ucsb.edu/data/chirtsmonthly">CHIRTS product</a> that has been pre-aggregated to the monthly level. For projects relying on average monthly temperature, this is likely a better option than manually aggregating more fine-grained CHIRTS data.</p>
<p>However, the advantage to working with <em>daily</em> CHIRTS data is that we have the flexibility to calculate our own custom monthly temperature metrics that aren’t necessarily provided out-of-the-box. We’ll demonstrate one in the next section.</p>
</section><section id="days-above" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="days-above">2. Days above a temperature threshold</h2>
<p>Average temperature may be a straightforward monthly temperature metric, but it doesn’t do a very good job of capturing acute temperature <strong>anomalies</strong>. When it comes to human health, evidence suggests that temperatures above certain thresholds are associated with physiological impairments, though the precise threshold depends on several factors.<span class="citation" data-cites="Vanos2020"><sup><a href="#ref-Vanos2020" role="doc-biblioref">3</a></sup></span> Regardless, these extreme events may be masked when we average across an entire month.</p>
<p>To explore this possibility, we’ll calculate the proportion of days in each month that exceed a certain raw temperature threshold. We’ll use 35°C as our threshold, which represents a value near the upper end of Mali’s temperature distribution<span class="citation" data-cites="Grace2021"><sup><a href="#ref-Grace2021" role="doc-biblioref">1</a></sup></span> and is similar to other commonly used (though occasionally questionable) thresholds.<span class="citation" data-cites="Vanos2020"><sup><a href="#ref-Vanos2020" role="doc-biblioref">3</a></sup></span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Typically, you would want a more thorough justification of your threshold temperature. This post is not intended to represent a real analysis, so we select 35°C for the purposes of demonstration.</p>
</div></div><section id="logical-raster-operations" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="logical-raster-operations">Logical raster operations</h3>
<p>We can exploit the fact that terra supports logical operations on <code>SpatRaster</code> objects to help us calculate this metric. For instance, we can compare the entire raster to a set value with the familiar <code>&gt;</code> operator:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_bin</span> <span class="op">&lt;-</span> <span class="va">ml_chirts</span> <span class="op">&gt;</span> <span class="fl">35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This produces a binary raster, where each pixel in each layer receives a logical value based on whether it is above or below 35 degrees Celsius (note that the <code>min values</code> and <code>max values</code> for each layer are now <code>TRUE</code> or <code>FALSE</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_bin</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 301, 335, 366  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.05, 0.05  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -12.35, 4.399999, 10.05, 25.1  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (CRS84) (OGC:CRS84) </span></span>
<span><span class="co">#&gt; source      : spat_d3403e6edae9_54080_GdaPwXHptgIOPSx.tif </span></span>
<span><span class="co">#&gt; varname     : Tmax (Climate Hazards Center Tmax) </span></span>
<span><span class="co">#&gt; names       : Tmax_1, Tmax_2, Tmax_3, Tmax_4, Tmax_5, Tmax_6, ... </span></span>
<span><span class="co">#&gt; min values  :  FALSE,  FALSE,  FALSE,  FALSE,  FALSE,  FALSE, ... </span></span>
<span><span class="co">#&gt; max values  :   TRUE,   TRUE,   TRUE,   TRUE,   TRUE,   TRUE, ... </span></span>
<span><span class="co">#&gt; time (days) : 2012-01-01 to 2012-12-31</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use this to count the number of days above the 35°C threshold for each pixel in our raster. We simply need to sum the binary raster layers within each month to count the number of days that exceed the threshold at each pixel location.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>When treating logical values as numeric, <code>TRUE</code> is treated as a <code>1</code> and <code>FALSE</code> is treated as a <code>0</code>.</p>
</div></div><p>However, we also need to account for the fact that not all months contain the same number of days. We therefore produce a <em>proportion</em> of each month’s days that meet our temperature threshold by dividing by the number of days in each month.</p>
<p>For binary data, this turns out to be the same as calculating a mean, so we can use a similar approach as we did when calculating average monthly temperature. The difference is that we now provide our binary raster (<code>ml_bin</code>) to the <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp</a></span><span class="op">(</span><span class="va">ml_bin</span>, fun <span class="op">=</span> <span class="va">mean</span>, index <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once again, we end up with a <code>SpatRaster</code> with 12 layers. However, in this case, each raster pixel reflects the proportion of days above 35° in that month.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to build individual panels for a small-multiple map using </span></span>
<span><span class="co"># binned color scheme</span></span>
<span><span class="va">chirts_panel_binned</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                                <span class="va">panel_title</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                <span class="va">fill_label</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                <span class="va">show_scale</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">ml_borders_out</span>, inverse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">r_in</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_neat</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#eeeeee"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ml_borders_out</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#7f7f7f"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="va">panel_title</span>, fill <span class="op">=</span> <span class="va">fill_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_chirts_b</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_dhs_map</span><span class="op">(</span>show_scale <span class="op">=</span> <span class="va">show_scale</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>      axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>      axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      legend.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Split raster by layer</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">split_raster</span><span class="op">(</span><span class="va">ml_prop</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map panels</span></span>
<span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">months</span>, <span class="va">show_scale</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="fu">chirts_panel_binned</span><span class="op">(</span></span>
<span>    <span class="va">x</span>, </span>
<span>    <span class="va">y</span>, </span>
<span>    <span class="va">z</span>, </span>
<span>    n.breaks <span class="op">=</span> <span class="fl">8</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>    fill_label <span class="op">=</span> <span class="st">"Proportion of Days Above 35°C"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">panels</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Proportion of Days Above Threshold"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/listing-img-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This approach reveals a bit more detail about the <em>consistency</em> of the temperature exposure during certain months. As we can see, some months are spent almost entirely above 35°C across the country. This continual exposure may be more strongly related to health than the averages we calculated in the section above.</p>
</section></section><section id="heatwaves-consecutive-days-above-a-temperature-threshold" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="heatwaves-consecutive-days-above-a-temperature-threshold">3. Heatwaves: Consecutive days above a temperature threshold</h2>
<p>Continual exposure to high temperatures likely has a more pronounced health impact than isolated hot days. Accordingly, most heatwave definitions attempt to identify <strong>sequences</strong> of days that meet certain temperature criteria.</p>
<p>We can build upon our previous temperature metric to produce a simple heatwave definition that identifies all days that belong to a sequence of 3+ days in a row that all meet the 35°C threshold used earlier.</p>
<p>How should we go about identifying sequences of days? To simplify things, let’s pull out the daily CHIRTS values for a single pixel in our raster to use as an example:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract values from a single pixel of CHIRTS data</span></span>
<span><span class="va">px1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">px1</span></span>
<span><span class="co">#&gt;   [1] 22.08196 22.25259 24.63318 25.46410 25.11430 24.69748 25.71723 27.64781</span></span>
<span><span class="co">#&gt;   [9] 25.00261 22.27929 24.83206 22.42412 24.87811 28.53550 27.20606 26.75240</span></span>
<span><span class="co">#&gt;  [17] 22.12105 22.98229 20.55801 19.10251 20.74286 22.91010 22.37615 22.23903</span></span>
<span><span class="va">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we demonstrated above, it’s easy to identify the layers that are above a given threshold:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">px1_bin</span> <span class="op">&lt;-</span> <span class="va">px1</span> <span class="op">&gt;</span> <span class="fl">35</span></span>
<span></span>
<span><span class="va">px1_bin</span></span>
<span><span class="co">#&gt;   [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">#&gt;  [13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">#&gt;  [25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="va">....</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But how do we extract <em>sequences</em> from this vector? One option is to exploit the features of <a href="https://en.wikipedia.org/wiki/Run-length_encoding">run-length encoding</a>. Run-length encoding represents a vector of values as a sequence of <em>runs</em> of a single value and the <em>length</em> of that run.</p>
<p>We can use the <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> function from base R to convert to run-length encoding:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">px1_rle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">px1_bin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">px1_rle</span></span>
<span><span class="co">#&gt; Run Length Encoding</span></span>
<span><span class="co">#&gt;   lengths: int [1:23] 81 1 16 1 30 11 3 3 7 1 ...</span></span>
<span><span class="co">#&gt;   values : logi [1:23] FALSE TRUE FALSE TRUE FALSE TRUE ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output shows us that the <code>px1_bin</code> vector starts with a run of 81 <code>FALSE</code> values, then has a run of 1 <code>TRUE</code> value, then 16 <code>FALSE</code> values, and so on. As you can see, run-length encoding provides us both with information about the <em>values</em> and the <em>sequencing</em> of our input vector.</p>
<p>If we define a heatwave as any sequence of 3+ days above the temperature threshold, each heatwave will be represented by entries with a <em>value</em> of <code>TRUE</code> (days that exceeded the threshold) <strong>and</strong> a <em>length</em> (number of days in a row) of 3 or more. We can use logical operations to identify whether each run is a heatwave or not:</p>
<div class="cell" data-out.lines="3">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Identify days that were above threshold and belonged to a 3+ day sequence</span></span>
<span><span class="va">is_heatwave</span> <span class="op">&lt;-</span> <span class="va">px1_rle</span><span class="op">$</span><span class="va">values</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">px1_rle</span><span class="op">$</span><span class="va">lengths</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">is_heatwave</span></span>
<span><span class="co">#&gt;  [1] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">#&gt; [13] FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Summing this vector will give us the number of unique <em>heatwave events</em> during the year for this sample pixel:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">is_heatwave</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could also get the proportion of days that are within those heatwaves by summing the lengths of all the heatwave events and dividing by the number of total days:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract lengths for each heatwave event</span></span>
<span><span class="va">heatwave_lengths</span> <span class="op">&lt;-</span> <span class="va">px1_rle</span><span class="op">$</span><span class="va">lengths</span><span class="op">[</span><span class="va">is_heatwave</span><span class="op">]</span></span>
<span></span>
<span><span class="va">heatwave_lengths</span></span>
<span><span class="co">#&gt; [1]  11   3   4 101   4   8   3   7</span></span>
<span></span>
<span><span class="co"># Proportion of days belonging to a heatwave</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">heatwave_lengths</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">px1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3852459</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="custom-functions" class="level3"><h3 class="anchored" data-anchor-id="custom-functions">Custom functions</h3>
<p>If we want to calculate the proportion of heatwave days across our entire raster, we can again return to <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code>. However, there’s no built-in function (like <code>mean</code>) that we can use to do the processing we walked through above.</p>
<p>Instead, we must provide our own <strong>custom function</strong> to indicate the processing that <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> should perform on each set of layers. To define a function, we use the <code>function()</code> keyword along with several <em>arguments</em>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A function’s arguments are the input parameters that the user can set when calling the function.</p>
</div>
</div>
<p>At its simplest, all this requires is copying the code we’ve already written above (we’ve consolidated the code into single lines in some cases):</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prop_heatwave</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">temps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Convert to RLE of days above threshold</span></span>
<span>  <span class="va">bin_rle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">temps</span> <span class="op">&gt;=</span> <span class="fl">35</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Identify heatwave events based on sequence length</span></span>
<span>  <span class="va">is_heatwave</span> <span class="op">&lt;-</span> <span class="va">bin_rle</span><span class="op">$</span><span class="va">values</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">bin_rle</span><span class="op">$</span><span class="va">lengths</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Count heatwave days and divide by total number of days</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bin_rle</span><span class="op">$</span><span class="va">lengths</span><span class="op">[</span><span class="va">is_heatwave</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">temps</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we do the exact same processing as we did in our step-by-step walkthrough. The only difference is that instead of using the <code>px1</code> variable (which contains the values for a single pixel), we instead use a more general argument, which we call <code>temps</code>. <code>temps</code> stands in for any arbitrary input vector that the function user can provide (we’ve named it <code>temps</code> to help make it clear that this should be a vector of temperature values). This means that we can easily run the same calculation on different vectors:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract 2 pixels for demonstration</span></span>
<span><span class="va">px1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">px2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ml_chirts</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate heatwave proportions for each pixel</span></span>
<span><span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">px1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3852459</span></span>
<span></span>
<span><span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">px2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3852459</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="writing-a-more-flexible-function" class="level4"><h4 class="anchored" data-anchor-id="writing-a-more-flexible-function">Writing a more flexible function</h4>
<p>Right now, the user of the function has no way to modify the temperature threshold or sequence length used in the heatwave definition, because those values (<code>35</code> and <code>3</code>) are <strong>hard-coded</strong> into our function.</p>
<p>If we move these values to the function arguments, we allow the <em>user</em> to decide what values these parameters should take. Here is a modified version of <code>prop_heatwave()</code> that does this:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prop_heatwave</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">temps</span>, <span class="va">thresh</span>, <span class="va">n_seq</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Convert to RLE of days above threshold</span></span>
<span>  <span class="va">bin_rle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">temps</span> <span class="op">&gt;=</span> <span class="va">thresh</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Identify heatwave events based on sequence length</span></span>
<span>  <span class="va">is_heatwave</span> <span class="op">&lt;-</span> <span class="va">bin_rle</span><span class="op">$</span><span class="va">values</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">bin_rle</span><span class="op">$</span><span class="va">lengths</span> <span class="op">&gt;=</span> <span class="va">n_seq</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Count heatwave days and divide by total number of days</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bin_rle</span><span class="op">$</span><span class="va">lengths</span><span class="op">[</span><span class="va">is_heatwave</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">temps</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our function now has a <code>thresh</code> argument and an <code>n_seq</code> argument. Where we previously would have compared our input <code>temps</code> vector to the threshold of <code>35</code>, we now compare it to the value the user provides to <code>thresh</code>. Similarly, where we previously would have used sequences of length <code>3</code> or more, we now use the sequence length the user provides to <code>n_seq</code>.</p>
<p>Using the values of 35 and 3 produces the same heatwave proportion as above:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">px1</span>, thresh <span class="op">=</span> <span class="fl">35</span>, n_seq <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3852459</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But now we can easily change our inputs to calculate modified heatwave definitions. For instance, to find the proportion of days in 4+ day heatwaves of at least 37°C:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">px1</span>, thresh <span class="op">=</span> <span class="fl">37</span>, n_seq <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3114754</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This example demonstrates how function arguments can be used to produce a more <em>flexible</em> function that can be easily applied across a range of input parameters. Building functions in this way has a bit of an up-front cost, but it often pays for itself by making your future analysis much more robust and scalable.</p>
</section></section><section id="scaling-up" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="scaling-up">Scaling up</h3>
<p>Now that we have a function to calculate our heatwave definition, we can provide it to <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> with our desired temperature threshold and sequence parameters.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Apply our custom heatwave counter to each month</span></span>
<span><span class="va">ml_heatwave_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp</a></span><span class="op">(</span></span>
<span>  <span class="va">ml_chirts</span>, </span>
<span>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">x</span>, thresh <span class="op">=</span> <span class="fl">35</span>, n_seq <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, </span>
<span>  index <span class="op">=</span> <span class="st">"months"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Anonymous Function Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our <code>fun</code> argument above is written in <em>anonymous function syntax</em>. It may look a little complex, but remember that <code><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp()</a></code> expects you to provide a <em>function</em> to its <code>fun</code> argument. Whichever function you provide should be a function of the vector of values for each pixel in the input raster.</p>
<p><code>function(x) prop_heatwave(x, ...)</code> indicates that we want to provide each of these vectors <code>x</code> to our <code>prop_heatwave()</code> function (as the <code>temps</code> argument). The <code>thresh</code> and <code>n_seq</code> arguments are fixed across all pixels. (In this case, <code>x</code> is just a placeholder to reference the vector inputs to our function. We could just as easily use another name, but <code>x</code> is traditional and concise.)</p>
<p>Why didn’t we use this syntax in previous sections? Well, it turns out that <code>fun = mean</code> was simply a shorthand. Writing <code>fun = function(x) mean(x)</code> would have also worked!</p>
</div>
</div>
<p>Let’s see what the distribution of heatwave days looks like under our latest definition:</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Split raster by layer</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">split_raster</span><span class="op">(</span><span class="va">ml_heatwave_prop</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map panels</span></span>
<span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">months</span>, <span class="va">show_scale</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="fu">chirts_panel_binned</span><span class="op">(</span></span>
<span>    <span class="va">x</span>, </span>
<span>    <span class="va">y</span>, </span>
<span>    <span class="va">z</span>, </span>
<span>    n.breaks <span class="op">=</span> <span class="fl">8</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    fill_label <span class="op">=</span> <span class="st">"Proportion of days in a heatwave"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">panels</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Proportion of heatwave days"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Heatwaves as sequences of 3+ days of 35°C"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Because we’ve built a flexible <code>prop_heatwave()</code> function, we can easily calculate a different heatwave definition. For heatwaves of 4+ days of 37°C+, for instance:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_heatwave_prop2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html">tapp</a></span><span class="op">(</span></span>
<span>  <span class="va">ml_chirts</span>, </span>
<span>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">prop_heatwave</span><span class="op">(</span><span class="va">x</span>, thresh <span class="op">=</span> <span class="fl">37</span>, n_seq <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, </span>
<span>  index <span class="op">=</span> <span class="st">"months"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Split raster by layer</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">split_raster</span><span class="op">(</span><span class="va">ml_heatwave_prop2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map panels</span></span>
<span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">months</span>, <span class="va">show_scale</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="fu">chirts_panel_binned</span><span class="op">(</span></span>
<span>    <span class="va">x</span>, </span>
<span>    <span class="va">y</span>, </span>
<span>    <span class="va">z</span>, </span>
<span>    n.breaks <span class="op">=</span> <span class="fl">8</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    fill_label <span class="op">=</span> <span class="st">"Proportion of days in a heatwave"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">panels</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Proportion of heatwave days"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Heatwaves as sequences of 4+ days of 37°C"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>It can be difficult to see the differences side-by-side, but we can subtract the output rasters to easily examine the differences between the two definitions:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_heatwave_diff</span> <span class="op">&lt;-</span> <span class="va">ml_heatwave_prop2</span> <span class="op">-</span> <span class="va">ml_heatwave_prop</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert 0 values to NA for transparency</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/NAflag.html">NAflag</a></span><span class="op">(</span><span class="va">ml_heatwave_diff</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Split raster into layers</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">split_raster</span><span class="op">(</span><span class="va">ml_heatwave_diff</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map panels</span></span>
<span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html">pmap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">months</span>, <span class="va">show_scale</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="fu">chirts_panel_binned</span><span class="op">(</span></span>
<span>    <span class="va">x</span>, </span>
<span>    <span class="va">y</span>, </span>
<span>    <span class="va">z</span>, </span>
<span>    pal <span class="op">=</span> <span class="st">"diff"</span>, </span>
<span>    n.breaks <span class="op">=</span> <span class="fl">8</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    fill_label <span class="op">=</span> <span class="st">"Difference in proportion of days in heatwave"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">panels</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Difference in heatwave proportion metrics"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"37°C 4+ days vs. 35°C 3+ days heatwave definitions"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center Infrared Temperature with Stations"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, modifying our definition does indeed produce meaningful differences in the prevalence of heatwave days in various parts of the country. Which definition is appropriate will depend on your particular research questions and aims. However, building custom functions into your workflow will make it much easier to quickly compare different definitions, facilitating sensitivity analyses and robustness checks.</p>
</section></section></section><section id="up-next" class="level1"><h1>Up next</h1>
<p>There are many temperature exposure concepts that we didn’t address in this post, like climatological normals, seasonality, humidity, and more. However, the techniques we introduced should give you a solid foundation for building flexible workflows to compute environmental metrics that you use commonly in your research.</p>
<p>This post is the first in a short series. In our next technical post, we’ll build on the metrics we produced here to demonstrate how we can use the monthly environmental data in conjunction with the dates recorded in DHS surveys.</p>
<p>We’ll extract values for our temperature metrics at the locations of the survey responses and attach these values to our DHS records on a month-by-month basis. This will allow us to finally link time-specific temperature values to individual births in the DHS!</p>
</section><div id="quarto-appendix" class="default"><section id="getting-help" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Getting Help</h2><div class="quarto-appendix-contents">
<p>Questions or comments? Check out the <a href="https://forum.ipums.org">IPUMS User Forum</a> or reach out to IPUMS User Support at ipums@umn.edu.</p>



</div></section><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Grace2021" class="csl-entry" role="listitem">
1. Grace, K., Verdin, A., Dorélien, A., Davenport, F., Funk, C., &amp; Husak, G. (2021). Exploring strategies for investigating the mechanisms linking climate and individual-level child health outcomes: An analysis of birth weight in <span>M</span>ali. <em>Demography</em>, <em>58</em>, 499–526. <a href="https://doi.org/10.1215/00703370-8977484">https://doi.org/10.1215/00703370-8977484</a>
</div>
<div id="ref-Funk2019" class="csl-entry" role="listitem">
2. Funk, C., Peterson, P., Peterson, S., Shukla, S., Davenport, F., Michaelsen, J., Knapp, K. R., Landsfeld, M., Husak, G., Harrison, L., Rowland, J., Budde, M., Meiburg, A., Dinku, T., Pedreros, D., &amp; Mata, N. (2019). A high-resolution 1983–2016 <span>T</span>max climate data record based on infrared temperatures and stations by the <span>C</span>limate <span>H</span>azard <span>C</span>enter. <em>Journal of Climate</em>, <em>32</em>, 5639–5658. <a href="https://doi.org/10.1175/JCLI-D-18-0698.1">https://doi.org/10.1175/JCLI-D-18-0698.1</a>
</div>
<div id="ref-Vanos2020" class="csl-entry" role="listitem">
3. Vanos, J. K., Baldwin, J. W., Jay, O., &amp; Ebi, K. L. (2020). Simplicity lacks robustness when projecting heat-health outcomes in a changing climate. <em>Nature Communications</em>, <em>11</em>, 1–5. <a href="https://doi.org/10.1038/s41467-020-19994-1">https://doi.org/10.1038/s41467-020-19994-1</a>
</div>
<div id="ref-Livezey2007" class="csl-entry" role="listitem">
4. Livezey, R. E., Vinnikov, K. Y., Timofeyeva, M. M., Tinker, R., &amp; van den Dool, H. M. (2007). Estimation and extrapolation of climate normals and climatic trends. <em>Journal of Applied Meteorology and Climatology</em>, <em>46</em>, 1759–1776. <a href="https://doi.org/10.1175/2007JAMC1666.1">https://doi.org/10.1175/2007JAMC1666.1</a>
</div>
</div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ipums\.github\.io\/dhs-research-hub");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Developed by <a href="https://www.ipums.org">IPUMS</a> at the University of Minnesota<br>Licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License Version 2.0</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>