<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Finn Roberts">
<meta name="author" content="Matt Gunther">
<meta name="dcterms.date" content="2024-02-04">
<meta name="description" content="Remotely sensed precipitation data can provide important context for understanding the health outcomes reported in the DHS">
<title>Attaching CHIRPS Precipitation Data to DHS Surveys – IPUMS DHS Spatial Analysis and Health Research Hub</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon/favicon-32x32.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-03fd5f99cfc2f8297f3c5ef65ead31dc.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-7590f946cc175b093b1053850525e467.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0WLH5S9VD5"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0WLH5S9VD5', { 'anonymize_ip': true});
</script>
<meta property="og:title" content="Attaching CHIRPS Precipitation Data to DHS Surveys">
<meta property="og:description" content="Remotely sensed precipitation data can provide important context for understanding the health outcomes reported in the DHS">
<meta property="og:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-02-04-dhs-chirps/index_files/figure-html/listing-img-1.png">
<meta property="og:site_name" content="IPUMS DHS Spatial Analysis and Health Research Hub">
<meta property="og:image:height" content="1536">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="Attaching CHIRPS Precipitation Data to DHS Surveys">
<meta name="twitter:description" content="Remotely sensed precipitation data can provide important context for understanding the health outcomes reported in the DHS">
<meta name="twitter:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-02-04-dhs-chirps/index_files/figure-html/listing-img-1.png">
<meta name="twitter:image-height" content="1536">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://www.idhsdata.org/idhs/" class="navbar-brand navbar-brand-logo">
    <img src="../../images/dhs_logo_white.png" alt="" class="navbar-logo"></a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Spatial Analysis and Health Research Hub</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-getting-started" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Getting Started</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-getting-started">
<li>
    <a class="dropdown-item" href="../../posts/2024-02-01-getting-started-with-r/index.html">
 <span class="dropdown-text">An Introduction to R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/2024-02-02-download-dhs-data/index.html">
 <span class="dropdown-text">Obtaining IPUMS DHS Data</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-community" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Community</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-community">
<li>
    <a class="dropdown-item" href="https://forum.ipums.org">
 <span class="dropdown-text">IPUMS Forum</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../CODE_OF_CONDUCT.html">
 <span class="dropdown-text">Code of Conduct</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../LICENSE.html">
 <span class="dropdown-text">License</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/ipums/dhs-research-hub"> 
<span class="menu-text"><i class="fa-brands fa-github" aria-label="github"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml"> 
<span class="menu-text"><i class="fa-solid fa-rss" aria-label="rss"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://twitter.com/ipumsGH"> 
<span class="menu-text"><i class="fa-brands fa-x-twitter" aria-label="x-twitter"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://forum.ipums.org"> 
<span class="menu-text"><i class="fa-solid fa-users" aria-label="users"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.ipums.org/"> 
<span class="menu-text"><i class="fa-solid fa-globe" aria-label="globe"></i></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Attaching CHIRPS Precipitation Data to DHS Surveys</h1>
                  <div>
        <div class="description">
          <p>Remotely sensed precipitation data can provide important context for understanding the health outcomes reported in the DHS</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">CHIRPS</div>
                <div class="quarto-category">Precipitation</div>
                <div class="quarto-category">Extreme weather</div>
                <div class="quarto-category">Agriculture</div>
                <div class="quarto-category">terra</div>
                <div class="quarto-category">sf</div>
                <div class="quarto-category">ggspatial</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Finn Roberts </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Senior Data Analyst, IPUMS
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author">Matt Gunther </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Research Methodologist, NORC
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 4, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">April 15, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#outline" id="toc-outline" class="nav-link active" data-scroll-target="#outline">Outline</a></li>
  <li>
<a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data sources</a>
  <ul class="collapse">
<li><a href="#ipums-dhs-survey-data" id="toc-ipums-dhs-survey-data" class="nav-link" data-scroll-target="#ipums-dhs-survey-data">IPUMS DHS survey data</a></li>
  <li>
<a href="#dhs-cluster-coordinates" id="toc-dhs-cluster-coordinates" class="nav-link" data-scroll-target="#dhs-cluster-coordinates">DHS cluster coordinates</a>
  <ul class="collapse">
<li><a href="#vector-data" id="toc-vector-data" class="nav-link" data-scroll-target="#vector-data">Vector data</a></li>
  <li><a href="#loading-cluster-coordinates" id="toc-loading-cluster-coordinates" class="nav-link" data-scroll-target="#loading-cluster-coordinates">Loading cluster coordinates</a></li>
  <li><a href="#visualizing" id="toc-visualizing" class="nav-link" data-scroll-target="#visualizing">Visualizing spatial data</a></li>
  </ul>
</li>
  <li>
<a href="#chirps-precipitation-data" id="toc-chirps-precipitation-data" class="nav-link" data-scroll-target="#chirps-precipitation-data">CHIRPS precipitation data</a>
  <ul class="collapse">
<li><a href="#raster-data" id="toc-raster-data" class="nav-link" data-scroll-target="#raster-data">Raster data</a></li>
  <li><a href="#loading-chirps-data" id="toc-loading-chirps-data" class="nav-link" data-scroll-target="#loading-chirps-data">Loading CHIRPS data</a></li>
  <li><a href="#spatraster-objects" id="toc-spatraster-objects" class="nav-link" data-scroll-target="#spatraster-objects"><code>SpatRaster</code> objects</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#summarize-precipitation-values" id="toc-summarize-precipitation-values" class="nav-link" data-scroll-target="#summarize-precipitation-values">Summarize precipitation values</a>
  <ul class="collapse">
<li><a href="#cluster-buffers" id="toc-cluster-buffers" class="nav-link" data-scroll-target="#cluster-buffers">Cluster buffers</a></li>
  <li>
<a href="#aggregating-rainfall-within-cluster-regions" id="toc-aggregating-rainfall-within-cluster-regions" class="nav-link" data-scroll-target="#aggregating-rainfall-within-cluster-regions">Aggregating rainfall within cluster regions</a>
  <ul class="collapse">
<li><a href="#scaling-up-for-all-clusters" id="toc-scaling-up-for-all-clusters" class="nav-link" data-scroll-target="#scaling-up-for-all-clusters">Scaling up for all clusters</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#join-data-sources" id="toc-join-data-sources" class="nav-link" data-scroll-target="#join-data-sources">Join data sources</a></li>
  <li>
<a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final thoughts</a>
  <ul class="collapse">

  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>We know that health outcomes are significantly impacted by individuals’ environmental context: excessive rainfall can flood local infrastructure<span class="citation" data-cites="Mirza2011"><sup><a href="#ref-Mirza2011" role="doc-biblioref">1</a></sup></span>; warmer temperatures can expand the range of common disease vectors<span class="citation" data-cites="Martens1997"><sup><a href="#ref-Martens1997" role="doc-biblioref">2</a></sup></span>; and drought can decimate crop-growing regions.<span class="citation" data-cites="Lesk2016"><sup><a href="#ref-Lesk2016" role="doc-biblioref">3</a></sup></span> However, survey data like those from <a href="https://www.dhsprogram.com/">The DHS Program</a> often provide only a limited view of the environmental trends in which individuals are embedded.</p>
<p>Developing a more holistic understanding of the role of environmental conditions in health outcomes therefore requires integrating external data sources with the survey data from DHS.</p>
<p>In this post we’ll demonstrate how to obtain raw precipitation data from the <a href="https://www.chc.ucsb.edu/data/chirps">Climate Hazards Center InfraRed Precipitation with Station dataset</a> (CHIRPS) and attach that data to survey responses from <a href="https://www.idhsdata.org/idhs/">IPUMS DHS</a>.</p>
<section id="outline" class="level1 page-columns page-full"><h1>Outline</h1>
<p>As a motivating example, we’ll consider whether historical precipitation rates have an effect on child stunting in Burkina Faso, measured with height-for-age Z-scores. Precipitation patterns in an area likely influence crop yields for local farms. Thus, by impairing food production, periods of low precipitation may also be related to child stunting.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The height-for-age Z-score represents the difference between the child’s height and the median height of a reference population of the same age and sex, expressed in standard deviation units.</p>
</div></div><p>To address this question, we will first need to gather data from several sources. In the <a href="#data-sources">Data sources</a> section, we demonstrate how to obtain</p>
<ul>
<li>DHS survey data from IPUMS DHS.</li>
<li>GPS coordinate data for DHS survey areas from The DHS Program.</li>
<li>daily precipitation data for 2001-2010 from CHIRPS.</li>
</ul>
<p>Next, in the <a href="#summarize-precipitation-values">Summarize precipitation values</a> section, we’ll summarize the daily precipitation data in the area around each DHS survey location. To do this, we’ll</p>
<ul>
<li>average the daily precipitation values across the 10-year time period to produce an estimate of the average millimeters of rainfall per day.</li>
<li>define a buffer region around each DHS survey location, allowing us to capture the trends in precipitation in the general vicinity of each survey location.</li>
<li>aggregate the precipitation data spatially to produce a single estimate of the average daily precipitation for each DHS survey area.</li>
</ul>
<p>Finally, in the <a href="#join-data-sources">Join data sources</a> section, we’ll attach the aggregated precipitation values for each survey area to the DHS survey responses from that area.</p>
</section><section id="data-sources" class="level1 page-columns page-full"><h1>Data sources</h1>
<section id="ipums-dhs-survey-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="ipums-dhs-survey-data">IPUMS DHS survey data</h2>
<p>To get started, we’ll download a data file (or <em>extract</em>, in IPUMS terms) from IPUMS DHS and load it into R. The extract in this post contains the <code>HWHAZWHO</code> variable (which contains the height-for-age Z-score) along with several pre-selected variables for the <strong>2010 Burkina Faso</strong> sample. If you need a refresher on how to download IPUMS DHS data, see the <a href="../2024-02-02-download-dhs-data/index.html">Downloading IPUMS DHS Data</a> post.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://tech.popdata.org/ipumsr/" class="hex"> <img src="../../images/hex/ipumsr.png" class="hex-img"></a> <p class="hex-cap">© IPUMS (MPL-2.0)</p> </div>
</div></div><p>We’ve downloaded and stored our XML codebook and compressed data file in the <code>data/dhs</code> directory. Be sure to update this path based on your local file setup, so you can follow along.</p>
<p>To simplify our output, we’ll select only a subset of the variables included in the extract:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tech.popdata.org/ipumsr/">ipumsr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load IPUMS DHS extract</span></span>
<span><span class="va">dhs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tech.popdata.org/ipumsr/reference/read_ipums_micro.html">read_ipums_micro</a></span><span class="op">(</span></span>
<span>  ddi <span class="op">=</span> <span class="st">"data/dhs/idhs_00018.xml"</span>,</span>
<span>  data_file <span class="op">=</span> <span class="st">"data/dhs/idhs_00018.dat.gz"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select a subset of variables</span></span>
<span><span class="va">dhs</span> <span class="op">&lt;-</span> <span class="va">dhs</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">SAMPLE</span>, <span class="va">YEAR</span>, <span class="va">IDHSPID</span>, <span class="va">IDHSHID</span>, <span class="va">DHSID</span>, <span class="va">URBAN</span>, <span class="va">HWHAZWHO</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dhs</span></span>
<span><span class="co">#&gt; # A tibble: 15,044 × 7</span></span>
<span><span class="co">#&gt;    SAMPLE                     YEAR IDHSPID      IDHSHID DHSID URBAN   HWHAZWHO  </span></span>
<span><span class="co">#&gt;    &lt;int+lbl&gt;                 &lt;int&gt; &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt; &lt;int+l&gt; &lt;int+lbl&gt; </span></span>
<span><span class="co">#&gt;  1 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… -264      </span></span>
<span><span class="co">#&gt;  2 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… -113      </span></span>
<span><span class="co">#&gt;  3 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur…  -13      </span></span>
<span><span class="co">#&gt;  4 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… -291      </span></span>
<span><span class="co">#&gt;  5 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… -211      </span></span>
<span><span class="co">#&gt;  6 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… 9999 [NIU…</span></span>
<span><span class="co">#&gt;  7 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… 9999 [NIU…</span></span>
<span><span class="co">#&gt;  8 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… -185      </span></span>
<span><span class="co">#&gt;  9 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur… 9999 [NIU…</span></span>
<span><span class="co">#&gt; 10 85404 [Burkina Faso 2010]  2010 85404      … 85404 … BF20… 2 [Rur…  -88      </span></span>
<span><span class="co">#&gt; # ℹ 15,034 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us a tabular data source containing 15,044 individual DHS survey responses for 7 variables. Of particular note is the <code>DHSID</code> variable (which stores the identifier for the location of the survey response).</p>
</section><section id="dhs-cluster-coordinates" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="dhs-cluster-coordinates">DHS cluster coordinates</h2>
<p>To meaningfully attach environmental data to our DHS survey responses, we’ll need to know the location where each survey response was collected. Fortunately, the DHS Program provides GPS coordinates for each surveyed household grouping, or <em>cluster</em>.</p>
<div id="displacement-rules" class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DHS Cluster Displacement
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s important to note that the GPS coordinates provided by The DHS Program do not actually reflect the exact location of the clusters. In fact, the coordinates provided are <strong>randomly displaced</strong> from their true locations, such that:</p>
<ul>
<li>urban clusters are displaced up to 2 kilometers in any direction.</li>
<li>99% of rural clusters are displaced up to 5 kilometers in any direction.</li>
<li>1% of rural clusters are displaced up to 10 kilometers in any direction.</li>
<li>displaced coordinates do not cross the country boundary and stay within the DHS survey region.</li>
</ul>
<p>The current demonstration doesn’t require a precise location of each cluster, so we will ignore this detail. However, for more fine-grained analyses (e.g.&nbsp;road network analyses), you may need to take displacement into account.</p>
<p>See the DHS <a href="https://www.dhsprogram.com/Methodology/GPS-Data.cfm">GPS data collection</a> documentation for more details about the DHS cluster point displacement methodology.</p>
</div>
</div>
<p>IPUMS DHS does not yet disseminate DHS cluster coordinates directly. For now, to obtain the GPS coordinates for a specific sample, you’ll have to <a href="https://dhsprogram.com/data/dataset_admin/login_main.cfm?CFID=213299554&amp;CFTOKEN=6d266879cd82102d-25F5B67E-C2E2-57E8-ECA142BF3516BEDD">log into</a> your account from The DHS Program. Specify your country of interest, and, on the line for the appropriate sample year, click the link to download the GPS coordinate data under the heading <strong>GPS Datasets</strong>. (Again, for this example, we’re using Burkina Faso’s 2010 sample.)</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>IPUMS DHS has recently received permission and funding to distribute DHS GPS data. Stay tuned, as these data will soon be available via IPUMS!</p>
</div></div><p>You’ll be presented with a new page containing a list of download links. Scroll down to the <strong>Geographic Datasets</strong> section. You have the option of downloading the file as either a shapefile (.shp) or a comma delimited file (.csv). For our purposes, we will download the <strong>shapefile</strong>, which contains spatial information in a format that can be easily interpreted by R (as well as by external GIS software).</p>
<p>For the Burkina Faso 2010 sample, the file should be named <code>BFGE61FL</code>. If you see a different file name, make sure you’re working with the correct survey year.</p>
<section id="vector-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="vector-data">Vector data</h3>
<p>Our DHS cluster coordinates are what’s known as <strong>vector data</strong>. Vector data refer to spatial data that represent geographic features using geometric shapes like points, lines, and polygons.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/plp1.png" class="img-fluid figure-img"></p>
<figcaption>Basic features of the vector data model<span class="citation" data-cites="Minn"><sup><a href="#ref-Minn" role="doc-biblioref">4</a></sup></span></figcaption></figure>
</div>
<p>In R, the <a href="https://r-spatial.github.io/sf/">sf</a> package provides an intuitive tabular framework for working with vector data. sf objects look much like a familiar <a href="https://tibble.tidyverse.org/">tibble</a> or <code>data.frame</code>, but also include an additional <code>geometry</code> column, which stores the spatial features that correspond to each set of observations.</p>

<!-- ::: column-margin -->
<!-- sf stands for "[simple -->
<!-- features](https://en.wikipedia.org/wiki/Simple_Features)", a concept -->
<!-- used commonly in geographic information systems (GIS). -->
<!-- ::: -->
<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://r-spatial.github.io/sf/index.html" class="hex"> <img src="../../images/hex/sf.png" class="hex-img"></a> <p class="hex-cap">© Edzer Pebesma (GPL-2 | MIT)</p> </div>
</div></div><section id="installing-sf" class="level4"><h4 class="anchored" data-anchor-id="installing-sf">Installing sf</h4>
<p>sf requires three <strong>operating system dependencies</strong>:</p>
<ul>
<li>
<a href="https://trac.osgeo.org/geos">GEOS</a> for geometrical operations on projected coordinates</li>
<li>
<a href="http://proj.org/">PRØJ</a> for coordinate reference system conversion and transformation</li>
<li>
<a href="http://www.gdal.org/">GDAL</a> for driver options</li>
</ul>
<p>Make sure to follow <a href="https://r-spatial.github.io/sf/index.html#installing">these instructions</a> to ensure that you set up <code>GEOS</code>, <code>PRØJ</code>, and <code>GDAL</code> when installing sf. The installation instructions may vary slightly, depending on your operating system. You may also need to update R, and then run <code>install.packages("sf")</code>.</p>
</section></section><section id="loading-cluster-coordinates" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="loading-cluster-coordinates">Loading cluster coordinates</h3>
<p>Once sf is installed, we can use <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read()</a></code> to load the file of GPS coordinate data we downloaded above. We’ve stored our shapefile in the <code>data/gps</code> directory. Again, make sure to adjust this path based on the location where you saved the file on your own system.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>A shapefile is actually a <em>collection</em> of several files; the primary file will have the .shp extension. Other files contain relevant metadata about the geometries contained in the .shp file (for instance, projection or index information).</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the 2010 BF cluster coordinate shapefile</span></span>
<span><span class="va">bf_gps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/gps/BFGE61FL/BFGE61FL.shp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `BFGE61FL' from data source </span></span>
<span><span class="co">#&gt;   `/Users/robe2037/Documents/projects/dhs-research-hub/posts/2024-02-04-dhs-chirps/data/gps/BFGE61FL/BFGE61FL.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 573 features and 20 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -5.426079 ymin: 5.684342e-14 xmax: 1.957316 ymax: 14.86258</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our resulting dataset looks something like a <code>tibble</code>, except that it contains a header describing a <strong>simple feature collection</strong> with 573 <em>features</em> and 20 <em>fields</em>:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bf_gps</span></span>
<span><span class="co">#&gt; Simple feature collection with 573 features and 20 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -5.426079 ymin: 5.684342e-14 xmax: 1.957316 ymax: 14.86258</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;             DHSID DHSCC DHSYEAR DHSCLUST CCFIPS ADM1FIPS ADM1FIPSNA ADM1SALBNA</span></span>
<span><span class="co">#&gt; 1  BF201000000001    BF    2010        1     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 2  BF201000000002    BF    2010        2     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 3  BF201000000003    BF    2010        3     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 4  BF201000000004    BF    2010        4     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 5  BF201000000005    BF    2010        5     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 6  BF201000000006    BF    2010        6     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 7  BF201000000007    BF    2010        7     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 8  BF201000000008    BF    2010        8     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 9  BF201000000009    BF    2010        9     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt; 10 BF201000000010    BF    2010       10     UV     NULL       NULL       NULL</span></span>
<span><span class="co">#&gt;    ADM1SALBCO ADM1DHS ADM1NAME DHSREGCO          DHSREGNA SOURCE URBAN_RURA</span></span>
<span><span class="co">#&gt; 1        NULL    9999     NULL       13         Sud-Ouest    GPS          R</span></span>
<span><span class="co">#&gt; 2        NULL    9999     NULL        2          Cascades    GPS          R</span></span>
<span><span class="co">#&gt; 3        NULL    9999     NULL       13         Sud-Ouest    GAZ          U</span></span>
<span><span class="co">#&gt; 4        NULL    9999     NULL       10              Nord    GPS          R</span></span>
<span><span class="co">#&gt; 5        NULL    9999     NULL        1 Boucle de Mouhoun    GPS          R</span></span>
<span><span class="co">#&gt; 6        NULL    9999     NULL        6      Centre-Ouest    GPS          R</span></span>
<span><span class="co">#&gt; 7        NULL    9999     NULL       12             Sahel    GPS          R</span></span>
<span><span class="co">#&gt; 8        NULL    9999     NULL        3            Centre    GPS          U</span></span>
<span><span class="co">#&gt; 9        NULL    9999     NULL        4        Centre-Est    GPS          U</span></span>
<span><span class="co">#&gt; 10       NULL    9999     NULL        5       Centre-Nord    GAZ          R</span></span>
<span><span class="co">#&gt;       LATNUM   LONGNUM ALT_GPS ALT_DEM DATUM                   geometry</span></span>
<span><span class="co">#&gt; 1  10.109415 -2.807555     269     269 WGS84 POINT (-2.807555 10.10942)</span></span>
<span><span class="co">#&gt; 2  10.388513 -3.907798     367     362 WGS84 POINT (-3.907798 10.38851)</span></span>
<span><span class="co">#&gt; 3   9.882864 -2.925703    9999     308 WGS84 POINT (-2.925703 9.882864)</span></span>
<span><span class="co">#&gt; 4  13.573418 -2.163120     323     323 WGS84  POINT (-2.16312 13.57342)</span></span>
<span><span class="co">#&gt; 5  12.453299 -3.461899     301     298 WGS84  POINT (-3.461899 12.4533)</span></span>
<span><span class="co">#&gt; 6  12.045308 -2.083828     338     325 WGS84 POINT (-2.083828 12.04531)</span></span>
<span><span class="co">#&gt; 7  14.354198 -0.672096     328     328 WGS84  POINT (-0.672096 14.3542)</span></span>
<span><span class="co">#&gt; 8  12.311034 -1.562071     322     324 WGS84 POINT (-1.562071 12.31103)</span></span>
<span><span class="co">#&gt; 9  11.780763 -0.363904     317     304 WGS84 POINT (-0.363904 11.78076)</span></span>
<span><span class="co">#&gt; 10 13.225114 -1.337994    9999     343 WGS84 POINT (-1.337994 13.22511)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each feature corresponds to one cluster location for which we have GPS coordinates, and each field represents a variable measured for each cluster. At the end of the output, you’ll also notice the aforementioned <code>geometry</code> column that contains the latitude and longitude for each displaced cluster location.</p>
<p>Some clusters contain unverified coordinates and have been assigned a location of (0, 0). Since we have no way of linking these clusters to environmental data, we will remove them for this analysis using dplyr’s <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove empty geographies</span></span>
<span><span class="va">bf_gps</span> <span class="op">&lt;-</span> <span class="va">bf_gps</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">LATNUM</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="va">LONGNUM</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualizing" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="visualizing">Visualizing spatial data</h3>
<p>It’s always worth double-checking that spatial data are being processed as expected, and this is often most easily done visually. We’ll use the <a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a> package to visualize our spatial data. This package is a convenient extension of the popular <a href="https://ggplot2.tidyverse.org">ggplot2</a> package.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://ggplot2.tidyverse.org/index.html" class="hex"> <img src="../../images/hex/ggplot2.png" class="hex-img"></a> <p class="hex-cap">© RStudio, Inc. (MIT)</p> </div>
</div></div><p>As with ggplot2, ggspatial allows us to think of our plot in layers. The primary difference is that ggspatial’s <code><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial()</a></code> automatically maps the plot’s x and y dimensions to the geographic coordinates in the data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ggplot2 and Themes
</div>
</div>
<div class="callout-body-container callout-body">
<p>This post isn’t intended to be an introduction to ggplot2, so don’t worry if some of the plot code is unfamiliar to you—you should still be able to follow along with the other content in the post.</p>
<p>Also, we’ve modified some of the default theme elements for use in our plots throughout this post. We won’t cover all the details here, but note that your plots will likely look a bit different if you’re following along. For more about themes, see the associated <a href="https://ggplot2.tidyverse.org/reference/theme.html">documentation</a>.</p>
</div>
</div>
<p>To add some context to our map, we’ll load a shapefile containing the Burkina Faso administrative borders. We’ll use the integrated geographies provided by IPUMS, which can be downloaded by clicking the <strong>shapefile</strong> link under the <strong>Burkina Faso</strong> section of <a href="https://www.idhsdata.org/idhs/gis.shtml">this table</a>. We’ve placed this shapefile alongside our DHS coordinate data in our <code>data/gps</code> directory, and can load it with <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read()</a></code>, as we did before:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load administrative boundary shapefile</span></span>
<span><span class="va">bf_borders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span></span>
<span>  <span class="st">"data/gps/geo_bf2003_2010/geo_bf2003_2010.shp"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can plot the cluster locations (stored in <code>bf_gps</code>) along with the Burkina Faso administrative boundaries (stored in <code>bf_borders</code>):</p>
<div class="cell page-columns page-full">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map with cluster locations and BF boundaries </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_gps</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Approximate DHS Cluster Locations"</span>, </span>
<span>    subtitle <span class="op">=</span> <span class="st">"Burkina Faso: 2010"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>, </span>
<span>    text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>    line_col <span class="op">=</span> <span class="st">"#999999"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>So far, everything seems to be working as expected—all the cluster points fall within the national borders, and there are noticeably more points in known urban areas, like the capital region of Ouagadougou. We should be safe to continue and load our precipitation data.</p>
</section></section><section id="chirps-precipitation-data" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="chirps-precipitation-data">CHIRPS precipitation data</h2>
<p>For this post, we will use precipitation data from <a href="https://www.chc.ucsb.edu/data/chirps">CHIRPS</a>, a quasi-global gridded rainfall time eries with data from 1981 to the near-present.<span class="citation" data-cites="Funk2015"><sup><a href="#ref-Funk2015" role="doc-biblioref">5</a></sup></span> CHIRPS is frequently used in health, agricultural, and hydrological research because of its relatively high spatial and temporal resolution, and validation studies have shown it to perform better than other leading precipitation models across several metrics.<span class="citation" data-cites="Pena-Guerrero2022 Pyarali2022"><sup><a href="#ref-Pena-Guerrero2022" role="doc-biblioref">6</a>,<a href="#ref-Pyarali2022" role="doc-biblioref">7</a></sup></span></p>
<p>Importantly, the CHIRPS data are provided as <strong>raster data</strong>, not vector data. Instead of representing precipitation with a set of polygons or points (as with vector data), raster data represent geographic features in a <em>grid</em>, where each cell in the grid is associated with a particular value. In our case, each cell is associated with a single daily precipitation value (in millimeters).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/plp2.png" class="img-fluid figure-img"></p>
<figcaption>Comparison of vector and raster data models<span class="citation" data-cites="Minn"><sup><a href="#ref-Minn" role="doc-biblioref">4</a></sup></span></figcaption></figure>
</div>
<p>sf doesn’t provide support for raster data—instead, we’ll turn to the <a href="https://rspatial.org/">terra</a> package.</p>
<section id="raster-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="raster-data">Raster data</h3>
<p>terra has rapidly become the go-to R package for working with raster data, and it is set to supersede the raster package, which was formerly used for raster operations.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://rspatial.github.io/terra/index.html" class="hex"> <img src="../../images/hex/terra.png" class="hex-img"></a> <p class="hex-cap">© Robert J. Hijmans et al. (GPL &gt;=3)</p> </div>
</div></div><p>In most cases, terra provides much faster processing than does the raster package. The magic behind terra is that it avoids reading many raster images into R at once. Instead, it reads <em>metadata</em> about each image—information about its spatial extent, coordinate reference system, pixel count, and so on.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
raster Package Retirement
</div>
</div>
<div class="callout-body-container callout-body">
<p>At the time of writing, the raster package is still available on CRAN, but it will be retired soon. You may see other resources referencing the raster package, but we suggest relying only on terra to ensure that your code is robust to the upcoming retirement.</p>
</div>
</div>
<section id="installing-terra" class="level4"><h4 class="anchored" data-anchor-id="installing-terra">Installing terra</h4>
<p>You’ll need the same operating system <a href="#installing-sf">dependencies</a> required for sf to use terra to its full potential. If you’ve already got those set up for sf, it should be easy to install terra with <code>install.packages("terra")</code>. If not, follow <a href="https://rspatial.github.io/terra/index.html#installation">these instructions</a> to set up the package.</p>
</section></section><section id="loading-chirps-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="loading-chirps-data">Loading CHIRPS data</h3>
<p>The complete CHIRPS precipitation data series can be downloaded directly from the <a href="https://data.chc.ucsb.edu/products/CHIRPS-2.0/">UCSB Climate Hazards Center</a>. However, because storing global data can require significant space, most users will likely want to download data for a specific area of interest.</p>
<p>There are two primary ways to go about downloading CHIRPS data for a particular area:</p>
<ol type="1">
<li>Select data interactively through the CHIRPS API provider: <a href="https://climateserv.servirglobal.net/">ClimateSERV</a>. ClimateSERV hosts a graphical user interface (GUI) that allows you to select an area of interest on a map.</li>
<li>Access data through the CHIRPS API using the API client tools provided by the <a href="https://docs.ropensci.org/chirps/">chirps</a> package.</li>
</ol>
<p>The first option has the advantage of being visual and intuitive. However, if you need to update your data for a new area or time range, you’ll have to go through the manual download process again.</p>
<p>In contrast, the second option prioritizes reproducibility and adaptability: updating the data used in your analysis is a matter of adjusting just a few lines of code. However, your R session will be occupied while downloading data, which can take a fair amount of time for long time series.</p>
<section id="option-1-climateserv" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="option-1-climateserv">Option 1: ClimateSERV</h4>
<p>First, navigate to the <a href="https://climateserv.servirglobal.net/map">ClimateSERV Map</a>. From there, open the <em>Statistical Query</em> toolbar on the top of the left sidebar and click <strong>Select</strong>. Click <strong>Country</strong> under the <em>Select features by</em> dropdown. Then, click on the country of interest—in this case, Burkina Faso (in West Africa).</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ClimateSERV interface may not work properly on all web browsers (e.g.&nbsp;Firefox). If you have difficulty, try opening the interface in a different browser.</p>
</div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="images/climateserv2.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Once you’ve indicated the country of interest, change the type of request to <strong>Download Raw Data</strong> and the download format to <strong>TIF</strong>. Finally, adjust the date range to start on <strong>01/01/2001</strong> and end on <strong>12/31/2010</strong>. This will give us a 10-year range running up to the survey year, allowing us to calculate a long-run average.</p>
<p>Finally, click <strong>Submit Query</strong> to download the daily rainfall totals. Note that downloading this much data may take a fair amount of time!</p>
<p>Once your request has been processed, you’ll receive a compressed (.zip) folder containing one TIF image for each day in the time span: that’s 3652 files containing many megabytes of raster data. We’ve placed the .zip file in the <code>data</code> directory and renamed it <code>chirps.zip</code>. You can unzip the file in R with <code><a href="https://rdrr.io/r/utils/unzip.html">unzip()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unzip and place individual .tif files in a new `data/chirps` directory</span></span>
<span><span class="va">chirps_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op">(</span><span class="st">"data/chirps.zip"</span>, exdir <span class="op">=</span> <span class="st">"data/chirps"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or, if you prefer to unzip the file manually, you can do so and then list the individual raster files with <code><a href="https://rdrr.io/r/base/list.files.html">list.files()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create list of paths to all individual raster files</span></span>
<span><span class="va">chirps_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"data/chirps"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can load raster files with the <code><a href="https://rspatial.github.io/terra/reference/rast.html">rast()</a></code> function from terra. When providing multiple files, terra will stack them so each input file becomes a single layer in a larger <strong>raster stack</strong>:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load set of .tif files into into a single raster stack</span></span>
<span><span class="va">bf_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">chirps_files</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="option-2-the-chirps-package" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="option-2-the-chirps-package">Option 2: The chirps package</h4>
<p>We can use the <code><a href="https://docs.ropensci.org/chirps/reference/get_chirps.html">get_chirps()</a></code> function from the <a href="https://docs.ropensci.org/chirps/">chirps</a> package to access CHIRPS data via the CHIRPS API. Since we don’t have a map where we can select our region of interest, we’ll have to provide a pre-loaded region representing the area for which we’d like data.</p>
<p>We can use the <code>bf_borders</code> object we created earlier to get data for the Burkina Faso region. We’ll use <code><a href="https://rspatial.github.io/terra/reference/vect.html">vect()</a></code> to convert it to a <code>SpatVector</code> from terra (<code><a href="https://docs.ropensci.org/chirps/reference/get_chirps.html">get_chirps()</a></code> currently has more robust support for these objects). We’ll also input our desired date range for which to obtain data:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The <code>SpatVector</code> is the main object terra uses to represent vector data. We’ve already shown how to use sf to handle vector data, but terra also provides support for this data model. In general, we find that sf’s vector objects are a little more intuitive, but there are some cases where using terra may make certain operations easier or faster.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load the chirps package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/chirps/">chirps</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get CHIRPS data from 2001-2010 for Burkina Faso </span></span>
<span><span class="va">bf_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/chirps/reference/get_chirps.html">get_chirps</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">bf_borders</span><span class="op">)</span>,</span>
<span>  dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001-01-01"</span>,<span class="st">"2010-12-31"</span><span class="op">)</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"CHC"</span> <span class="co"># Recommended when obtaining data for multiple dates and/or locations</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://docs.ropensci.org/chirps/reference/get_chirps.html">get_chirps()</a></code> obtains data for a rectangular region around the country. For consistency with the results you would get from ClimateSERV (which only downloads data within the country borders), we’ll use terra’s <code><a href="https://rspatial.github.io/terra/reference/mask.html">mask()</a></code> function to remove data from outside the Burkina Faso borders:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bf_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">bf_precip</span>, <span class="va">bf_borders</span>, touches <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ClimateSERV vs.&nbsp;chirps
</div>
</div>
<div class="callout-body-container callout-body">
<p>There may be some trivial discrepancies between the data obtained via ClimateSERV and those obtained via the chirps package. When creating this post, we used data obtained via ClimateSERV.</p>
<p>If you instead obtained data from chirps, your values may differ slightly from those we present below. These differences shouldn’t meaningfully affect any of the operations we demonstrate.</p>
</div>
</div>
</section></section><section id="spatraster-objects" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="spatraster-objects">
<code>SpatRaster</code> objects</h3>
<p>Regardless of the method you chose to access the CHIRPS data, you should now have a <code>SpatRaster</code> object from terra containing the raster stack of precipitation data covering the entirety of Burkina Faso from 2001 to 2010:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bf_precip</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 115, 159, 3652  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.05, 0.05  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -5.549997, 2.400003, 9.349999, 15.1  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">#&gt; sources     : 20010101.tif  </span></span>
<span><span class="co">#&gt;               20010102.tif  </span></span>
<span><span class="co">#&gt;               20010103.tif  </span></span>
<span><span class="co">#&gt;               ... and 3649 more sources</span></span>
<span><span class="co">#&gt; names       : 20010101, 20010102, 20010103, 20010104, 20010105, 20010106, ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, this raster layer contains 115 rows and 159 columns of pixels. The value in each pixel represents the rainfall (in millimeters) for an area 0.05 degrees longitude by 0.05 degrees latitude (shown in the <code>resolution</code> field).</p>
<p>Each of the 3652 layers in the <code>SpatRaster</code> represents the CHIRPS precipitation values for a single day of the 10-year period between 2001 and 2010.</p>
<p>To better understand this structure, we can visualize the rainfall patterns for one of these days. We’ll first need to select an individual layer from the raster stack. We can index layers by name or layer position using <code>[[</code> notation:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select a single layer</span></span>
<span><span class="co"># (Layer names will vary depending on how you obtained your CHIRPS data)</span></span>
<span><span class="va">precip_day</span> <span class="op">&lt;-</span> <span class="va">bf_precip</span><span class="op">[[</span><span class="st">"20010719"</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we’ve selected a layer, we can use <code><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial()</a></code> to plot it, just as we did for vector objects.</p>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create map of rainfall for single day</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span></span>
<span>    <span class="va">precip_day</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html">values</a></span><span class="op">(</span><span class="va">precip_day</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.8</span><span class="op">)</span>, </span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"#888888"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_gps</span>,  fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Burkina Faso Rainfall: July 19, 2001"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"CHIRPS precipitation data with DHS cluster locations"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Rainfall total (mm)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program and Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>, </span>
<span>    text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>    line_col <span class="op">=</span> <span class="st">"#999999"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"#00263A"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>It can be unwieldy to manage many layers of raster data. In the next section, we’ll introduce methods for simplifying these data across both time and space so they can be more easily attached to our DHS survey.</p>
</section></section></section><section id="summarize-precipitation-values" class="level1 page-columns page-full" data-link="Summarize precipitation values"><h1 data-link="Summarize precipitation values">Summarize precipitation values</h1>
<p>The terra package contains several <a href="https://rspatial.github.io/terra/reference/summarize-generics.html">summary methods</a> we can use to quickly explore summary statistics across all of the layers included in our multi-year timespan. For example, <code><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean()</a></code> computes the mean daily precipitation value for each pixel location across all layers (days) of our CHIRPS data:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate mean daily precipitation value for each pixel (mm/day)</span></span>
<span><span class="va">bf_precip_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="va">bf_precip</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bf_precip_mean</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 115, 159, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.05, 0.05  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -5.549997, 2.400003, 9.349999, 15.1  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; name        :      mean </span></span>
<span><span class="co">#&gt; min value   : 0.8771938 </span></span>
<span><span class="co">#&gt; max value   : 3.1498873</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that this produces another <code>SpatRaster</code> and that the result only has one layer. This makes sense, because <code><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean()</a></code> uses all of the input raster layers to produce a single average precipitation (in millimeters per day) for each cell.</p>
<p>Since <code><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean()</a></code> produces another <code>SpatRaster</code>, we can plot the average values for the 10-year time span just as we did with a single day’s worth of precipitation data:</p>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_borders</span>, alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Burkina Faso Average Rainfall: 2001-2010"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"CHIRPS precipitation data"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>,</span>
<span>    text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>    line_col <span class="op">=</span> <span class="st">"#999999"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#FAEFD1"</span>, high <span class="op">=</span> <span class="st">"#00263A"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>At this point, our primary data sources still remain completely independent. We know the approximate location of the DHS clusters, and we have a summary of the average daily precipitation across Burkina Faso, but we haven’t linked the two together to create a specific precipitation record for each cluster.</p>
<p>Our remaining task is to <strong>extract</strong> the mean precipitation values from the CHIRPS raster at each of the DHS cluster locations.</p>
<section id="cluster-buffers" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="cluster-buffers">Cluster buffers</h2>
<p>We might think it logical to extract the mean precipitation values at each cluster’s point location. However, recall that our motivating question centered around the idea that precipitation influences health by way of impacting local crop yields. The farms that serve the population of a given cluster won’t necessarily be situated right at the recorded cluster location. Furthermore, each farm is probably impacted by the precipitation patterns in its surrounding area, not only those that occur at its exact location.</p>
<p>With this in mind, it makes sense to generate a summary metric of the precipitation in the <em>general area</em> of each cluster, rather than at the cluster point locations. We can accomplish this by creating <strong>buffer zones</strong> around each cluster coordinate.</p>
<p>We can use <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer()</a></code> to create an appropriately sized buffer zone around the displaced GPS coordinates for each cluster. However, sf’s geometrical operations (powered by GEOS) assume that the input data are in <em>meters</em>, and our data are currently in <em>degrees</em>.</p>
<p>Therefore, we first need to <strong>project</strong> our GPS coordinates into a new coordinate reference system, or CRS. We will use the <a href="https://pubs.usgs.gov/fs/2001/0077/report.pdf">UTM Coordinate System</a> Zone 30N for our projection, which provides limited distortion for Burkina Faso. The <a href="https://epsg.io/about">EPSG</a> code for this UTM zone is 32630, which we can provide to <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> to project our data:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Map projections constitute an entire topic on their own. To learn more about projected coordinate systems, there are countless resources online, like <a href="http://downloads2.esri.com/support/documentation/ao_/710Understanding_Map_Projections.pdf">this treatment</a> from <a href="https://www.esri.com/en-us/home">ESRI</a></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Project cluster locations to the UTM 30N reference system</span></span>
<span><span class="va">bf_gps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">bf_gps</span>, crs <span class="op">=</span> <span class="fl">32630</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use <code><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry()</a></code> to see a summary of our sf object’s geometry. Note that the <code>Projected CRS</code> now shows <code>UTM zone 30N</code>, and that our data are now stored in meters, rather than degrees:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">bf_gps</span><span class="op">)</span></span>
<span><span class="co">#&gt; Geometry set for 541 features </span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 234659.3 ymin: 1092462 xmax: 1039190 ymax: 1645174</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 30N</span></span>
<span><span class="co">#&gt; First 5 geometries:</span></span>
<span><span class="co">#&gt; POINT (521084.1 1117516)</span></span>
<span><span class="co">#&gt; POINT (400626 1148510)</span></span>
<span><span class="co">#&gt; POINT (508145.5 1092462)</span></span>
<span><span class="co">#&gt; POINT (590542.4 1500704)</span></span>
<span><span class="co">#&gt; POINT (449803.2 1376723)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>If you need to check your work, you can always access the current CRS of your data with <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code>.</p>
</div></div><p>Now that we’re working in meters, we can buffer our points using <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer()</a></code>. The appropriate buffer distance will depend on your specific research question of interest. For this demonstration, we’ll create a 10-kilometer (10,000 meter) buffer by setting <code>dist = 10000</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bf_gps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">bf_gps</span>, dist <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the geometry column now describes <code>POLYGON</code> geometries rather than <code>POINT</code> geometries. Each polygon is defined by a series of points that form the circumference of the buffer zone.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">bf_gps</span><span class="op">)</span></span>
<span><span class="co">#&gt; Geometry set for 541 features </span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 224659.3 ymin: 1082462 xmax: 1049190 ymax: 1655174</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 30N</span></span>
<span><span class="co">#&gt; First 5 geometries:</span></span>
<span><span class="co">#&gt; POLYGON ((531084.1 1117516, 531070.3 1116993, 5...</span></span>
<span><span class="co">#&gt; POLYGON ((410626 1148510, 410612.3 1147987, 410...</span></span>
<span><span class="co">#&gt; POLYGON ((518145.5 1092462, 518131.8 1091939, 5...</span></span>
<span><span class="co">#&gt; POLYGON ((600542.4 1500704, 600528.7 1500181, 6...</span></span>
<span><span class="co">#&gt; POLYGON ((459803.2 1376723, 459789.5 1376200, 4...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re finished measuring distance in meters, so we’ll again use <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> to revert back to degrees of latitude and longitude (EPSG 4326) for consistency with our other maps.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bf_gps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">bf_gps</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_gps</span>, fill <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Buffered DHS Cluster Locations"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Burkina Faso: 2010"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>, </span>
<span>    text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>    line_col <span class="op">=</span> <span class="st">"#999999"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Handling cluster displacement
</div>
</div>
<div class="callout-body-container callout-body">
<p>Previously, we discussed the fact that the cluster coordinates provided by The DHS Program are <a href="#displacement-rules">displaced</a> from their true locations. While we don’t need to address this for our precipitation data, there may be other cases where it is useful to obtain a more precise location for each cluster (for instance, if working with road networks or other fine-grained data).</p>
<p>In these cases, you can certainly buffer points conditionally on other values in the data by providing a conditional statement to the buffer <code>dist</code> argument. For instance, to buffer urban clusters (<code>URBAN_RURA == "U"</code>) by 2000 meters and other clusters by 5000 meters, use an <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> statement:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span></span>
<span>  <span class="va">bf_gps</span>, </span>
<span>  dist <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">bf_gps</span><span class="op">$</span><span class="va">URBAN_RURA</span> <span class="op">==</span> <span class="st">"U"</span>, <span class="fl">2000</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section><section id="aggregating-rainfall-within-cluster-regions" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="aggregating-rainfall-within-cluster-regions">Aggregating rainfall within cluster regions</h2>
<p>Now that we have buffered cluster regions, we can focus on combining our two data sources. Let’s zoom in on a single cluster as an example. We’ll use the cluster with <code>DHSCLUST</code> number <code>160</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="va">bf_gps</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DHSCLUST</span> <span class="op">==</span> <span class="fl">160</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To simplify this example, we’ll use terra’s <code><a href="https://rspatial.github.io/terra/reference/crop.html">crop()</a></code> to restrict our raster to the cells surrounding this cluster:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">precip_clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, <span class="va">clust</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">precip_clust</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">clust</span>, alpha <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Average Rainfall: 2001-2010"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Single DHS cluster"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program and Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"#FAEFD1"</span>, </span>
<span>    high <span class="op">=</span> <span class="st">"#00263A"</span>, </span>
<span>    na.value <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.3</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>For demonstration purposes, we’ve used different limits for the color scale in this plot and the next. In general, we’d want to ensure that the colors in this plot map to the same values used in other plots with the same color scheme.</p>
</div></div><p>We see a range of rainfall totals across the 20 pixels in this area. How can we summarize the information contained in these individual pixels into a single estimate of the rainfall for this buffered cluster region?</p>
<p>The most straightforward approach might be to take the mean of all the pixel values that overlap our buffer region. First, we need to obtain the values of the overlapping raster cells. We can use terra’s <code><a href="https://rspatial.github.io/terra/reference/extract.html">extract()</a></code> to obtain the raster cell values from the region defined by an overlapping vector data source (in this case, our example cluster, <code>clust</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, <span class="va">clust</span><span class="op">)</span></span>
<span><span class="co">#&gt;    ID     mean</span></span>
<span><span class="co">#&gt; 1   1 2.337887</span></span>
<span><span class="co">#&gt; 2   1 2.329431</span></span>
<span><span class="co">#&gt; 3   1 2.344792</span></span>
<span><span class="co">#&gt; 4   1 2.317271</span></span>
<span><span class="co">#&gt; 5   1 2.343546</span></span>
<span><span class="co">#&gt; 6   1 2.329051</span></span>
<span><span class="co">#&gt; 7   1 2.381871</span></span>
<span><span class="co">#&gt; 8   1 2.367312</span></span>
<span><span class="co">#&gt; 9   1 2.395538</span></span>
<span><span class="co">#&gt; 10  1 2.395361</span></span>
<span><span class="co">#&gt; 11  1 2.402505</span></span>
<span><span class="co">#&gt; 12  1 2.415130</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that this provides mean daily precipitation values for 12 different cells. By default, <code><a href="https://rspatial.github.io/terra/reference/extract.html">extract()</a></code> will only extract values from the cells whose <em>center point</em> lies within the overlaid polygon:</p>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># New SpatRaster with same extent as bf_precip_mean, but with empty values</span></span>
<span><span class="va">ext_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, vals <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ID cell locations for each cell that is extracted</span></span>
<span><span class="va">cell_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">ext_cells</span>, <span class="va">clust</span>, cells <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">cell</span></span>
<span></span>
<span><span class="va">ext_cells</span><span class="op">[</span><span class="va">cell_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bf_precip_mean</span><span class="op">[</span><span class="va">cell_idx</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">ext_cells</span>, <span class="va">clust</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span>, </span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">clust</span>, alpha <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Average Rainfall: 2001-2010"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Single DHS cluster"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program and Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"#FAEFD1"</span>, </span>
<span>    high <span class="op">=</span> <span class="st">"#00263A"</span>, </span>
<span>    na.value <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.3</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>To instead include <em>all</em> cells that intersect the polygon, set <code>touches = TRUE</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">clust_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, <span class="va">clust</span>, touches <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clust_precip</span></span>
<span><span class="co">#&gt;    ID     mean</span></span>
<span><span class="co">#&gt; 1   1 2.350189</span></span>
<span><span class="co">#&gt; 2   1 2.319925</span></span>
<span><span class="co">#&gt; 3   1 2.385132</span></span>
<span><span class="co">#&gt; 4   1 2.337887</span></span>
<span><span class="co">#&gt; 5   1 2.329431</span></span>
<span><span class="co">#&gt; 6   1 2.328763</span></span>
<span><span class="co">#&gt; 7   1 2.344792</span></span>
<span><span class="co">#&gt; 8   1 2.317271</span></span>
<span><span class="co">#&gt; 9   1 2.343546</span></span>
<span><span class="co">#&gt; 10  1 2.329051</span></span>
<span><span class="co">#&gt; 11  1 2.381871</span></span>
<span><span class="co">#&gt; 12  1 2.367312</span></span>
<span><span class="co">#&gt; 13  1 2.395538</span></span>
<span><span class="co">#&gt; 14  1 2.395361</span></span>
<span><span class="co">#&gt; 15  1 2.393321</span></span>
<span><span class="co">#&gt; 16  1 2.402505</span></span>
<span><span class="co">#&gt; 17  1 2.415130</span></span>
<span><span class="co">#&gt; 18  1 2.395817</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This operation provides the mean daily precipitation values for each of the 18 cells that intersect our cluster region. However, some cells cover a much larger portion of the cluster region than others. To account for the heterogeneity in size, we can set <code>weights = TRUE</code> to include a <code>weight</code> column, which records the proportion of each cell that is covered by the polygon:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>weights = TRUE</code> automatically includes all intersected cells, but those with negligible weights will be removed.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">clust_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">bf_precip_mean</span>, <span class="va">clust</span>, weights <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clust_precip</span></span>
<span><span class="co">#&gt;    ID     mean weight</span></span>
<span><span class="co">#&gt; 1   1 2.385132   0.20</span></span>
<span><span class="co">#&gt; 2   1 2.337887   0.90</span></span>
<span><span class="co">#&gt; 3   1 2.329431   0.94</span></span>
<span><span class="co">#&gt; 4   1 2.328763   0.33</span></span>
<span><span class="co">#&gt; 5   1 2.344792   0.70</span></span>
<span><span class="co">#&gt; 6   1 2.317271   1.00</span></span>
<span><span class="co">#&gt; 7   1 2.343546   1.00</span></span>
<span><span class="co">#&gt; 8   1 2.329051   0.86</span></span>
<span><span class="co">#&gt; 9   1 2.381871   0.57</span></span>
<span><span class="co">#&gt; 10  1 2.367312   1.00</span></span>
<span><span class="co">#&gt; 11  1 2.395538   1.00</span></span>
<span><span class="co">#&gt; 12  1 2.395361   0.74</span></span>
<span><span class="co">#&gt; 13  1 2.393321   0.03</span></span>
<span><span class="co">#&gt; 14  1 2.402505   0.47</span></span>
<span><span class="co">#&gt; 15  1 2.415130   0.53</span></span>
<span><span class="co">#&gt; 16  1 2.395817   0.09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then provide the weights to the <code><a href="https://rspatial.github.io/terra/reference/weighted.mean.html">weighted.mean()</a></code> function to calculate a weighted mean that is shifted toward the cell values that form a larger proportion of the polygon area.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">clust_precip</span><span class="op">$</span><span class="va">mean</span>, <span class="va">clust_precip</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.358508</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because this kind of workflow is so common, terra provides a quicker shorthand in <code><a href="https://rspatial.github.io/terra/reference/extract.html">extract()</a></code>. You can use the <code>fun</code> argument to specify an aggregation function at the same time that you extract the raster cell values:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract area-weighted average for all cells covered by `clust`</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>  <span class="va">bf_precip_mean</span>,</span>
<span>  <span class="va">clust</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>, <span class="co"># Average all extracted values</span></span>
<span>  weights <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Use area weights</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID     mean</span></span>
<span><span class="co">#&gt; 1  1 2.358508</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>2.358508</code> value represents the area-weighted mean of the 10-year mean precipitation values (in millimeters per day) within the given cluster region.</p>
<section id="scaling-up-for-all-clusters" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="scaling-up-for-all-clusters">Scaling up for all clusters</h3>
<p>To aggregate the rainfall data for each DHS cluster in the sample, we simply scale up. We again use <code><a href="https://rspatial.github.io/terra/reference/extract.html">extract()</a></code>, but we provide our raster of precipitation values for the entire country and the polygons for all of our buffered clusters.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Average the mean CHIRPS values within each DHS cluster</span></span>
<span><span class="va">clust_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>  <span class="va">bf_precip_mean</span>,</span>
<span>  <span class="va">bf_gps</span>, <span class="co"># All clusters included</span></span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Ignore missing CHIRPS values</span></span>
<span>  bind <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Recombine with original `bf_gps` data</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By setting <code>bind = TRUE</code>, we can automatically recombine the extracted means with the other cluster data in <code>bf_gps</code>.</p>
<p>We also set <code>na.rm = TRUE</code> to ensure we don’t get missing values for clusters whose regions expand beyond the country borders (where we haven’t downloaded any CHIRPS data). This decision may be reasonable if our interest is in rainfall over local crop-producing regions, and we don’t believe that clusters in border regions obtain substantial inputs from farms outside of the country. (If we wanted to include the rainfall outside of the country borders, we would simply need to expand our bounding box when downloading our CHIRPS data.)</p>
<p>Finally, we’ll convert our cluster means back to an sf object. Notice that there now exists a <code>mean</code> column that stores the weighted mean values for each cluster:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert to sf object</span></span>
<span><span class="va">clust_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">clust_means</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clust_means</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">DHSID</span>, <span class="va">mean</span>, <span class="va">geometry</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 541 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -5.517451 ymin: 9.792417 xmax: 2.049008 ymax: 14.95288</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;             DHSID     mean                       geometry</span></span>
<span><span class="co">#&gt; 1  BF201000000001 2.758146 POLYGON ((-2.71628 10.10935...</span></span>
<span><span class="co">#&gt; 2  BF201000000002 2.782180 POLYGON ((-3.816453 10.3887...</span></span>
<span><span class="co">#&gt; 3  BF201000000003 3.004422 POLYGON ((-2.834491 9.88283...</span></span>
<span><span class="co">#&gt; 4  BF201000000004 1.678181 POLYGON ((-2.070699 13.5730...</span></span>
<span><span class="co">#&gt; 5  BF201000000005 2.129466 POLYGON ((-3.369883 12.4534...</span></span>
<span><span class="co">#&gt; 6  BF201000000006 2.203529 POLYGON ((-1.991964 12.0449...</span></span>
<span><span class="co">#&gt; 7  BF201000000007 1.113443 POLYGON ((-0.579432 14.3532...</span></span>
<span><span class="co">#&gt; 8  BF201000000008 2.110246 POLYGON ((-1.470133 12.3105...</span></span>
<span><span class="co">#&gt; 9  BF201000000009 2.281224 POLYGON ((-0.2722169 11.779...</span></span>
<span><span class="co">#&gt; 10 BF201000000010 1.722371 POLYGON ((-1.245736 13.2245...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have aggregated rainfall across all clusters, we can plot the average rainfall for each of the 10-kilometer buffered cluster regions. Each cluster region is associated with a single 10-year average rainfall value.</p>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">bf_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">clust_means</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Average Rainfall within Clusters: 2001-2010"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Burkina Faso: 2010 Clusters"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: DHS Program and Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html">annotation_scale</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"ticks"</span>, location <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>, </span>
<span>    text_col <span class="op">=</span> <span class="st">"#999999"</span>,</span>
<span>    line_col <span class="op">=</span> <span class="st">"#999999"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_steps.html">scale_fill_steps</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#FAEFD1"</span>, high <span class="op">=</span> <span class="st">"#00263A"</span>, n.breaks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/listing-img-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section></section><section id="join-data-sources" class="level1 page-columns page-full"><h1>Join data sources</h1>
<p>At this point, we have our aggregated CHIRPS data merged with our DHS <em>clusters</em>, but not with the individual DHS survey <em>responses</em>.</p>
<p>To accomplish this last task, we need to merge the cluster means with the survey responses, based on the cluster where each response was recorded. This information is stored in the <code>DHSID</code> variable provided by IPUMS DHS.</p>
<p>We’ll use dplyr’s <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> to merge the survey responses with the mean precipitation values for each cluster, matching records using their <code>DHSID</code> code. Using <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> ensures that responses from clusters with no location information (which have been filtered out of <code>clust_means</code>) are not included in the output.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Join survey responses and cluster precipitation values, based on</span></span>
<span><span class="co"># the cluster where each response was recorded (DHSID)</span></span>
<span><span class="va">dhs_chirps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span></span>
<span>  <span class="va">dhs</span>,</span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="va">clust_means</span><span class="op">)</span>, <span class="co"># remove geometry for simplicity in output</span></span>
<span>  by <span class="op">=</span> <span class="st">"DHSID"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can finally link the 10-year mean precipitation value to each sample participant’s outcomes. To demonstrate, we clean up the <code>HWHAZWHO</code> variable and visualize the relationship between 10-year average precipitation and childrens’ height-for-age in Z-scores:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>ipumsr includes helper functions to view the metadata for IPUMS variables. For instance, <code><a href="https://tech.popdata.org/ipumsr/reference/ipums_var_info.html">ipums_val_labels()</a></code> can show us the missing value codes for a given variable, which we can use when cleaning our data.</p>
</div></div><div class="cell page-columns page-full">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Clean up HWHAZWHO for plotting</span></span>
<span><span class="va">dhs_chirps_recode</span> <span class="op">&lt;-</span> <span class="va">dhs_chirps</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">HWHAZWHO</span> <span class="op">&lt;</span> <span class="fl">9995</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Remove missing HWHAZWHO values</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>HWHAZWHO <span class="op">=</span> <span class="va">HWHAZWHO</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span> <span class="co"># Recode decimal place based on IPUMS documentation</span></span>
<span></span>
<span><span class="co"># Create scatterplot of mean precipitation value vs. HWHAZWHO </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean</span>, y <span class="op">=</span> <span class="va">HWHAZWHO</span>, fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, </span>
<span>    data <span class="op">=</span> <span class="va">dhs_chirps_recode</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"#999999"</span>, </span>
<span>    shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Average Rainfall and Stunting"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Burkina Faso: 2010 Clusters"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Height for Age Z-Score"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"10-year average rainfall (mm/day)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: IPUMS DHS, DHS Program, and Climate Hazards Center InfraRed Precipitation with Station (CHIRPS)"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#FAEFD1"</span>, high <span class="op">=</span> <span class="st">"#00263A"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Since our rainfall metric is now linked to each individual’s survey response, we can include average rainfall as a predictor when analyzing the health outcomes provided by IPUMS DHS.</p>
</section><section id="final-thoughts" class="level1"><h1>Final thoughts</h1>
<p>This post has introduced several core concepts for including spatial data in an analysis, including:</p>
<ul>
<li>the distinction between vector and raster data</li>
<li>the main packages (sf and terra) used for working with spatial data in R</li>
<li>methods for summarizing longitudinal spatial data across time</li>
<li>spatial buffering and methods for aggregating raster values within polygons</li>
<li>the importance of considering the geographic context of spatial data when deciding the most appropriate way to include such data in an analysis</li>
</ul>
<p>That being said, many of the techniques we introduced will be too simplistic for most analyses.</p>
<p>For instance, a single long-run average is unlikely to capture much nuance in the way precipitation influences nutrition. Instead, it might be more meaningful to determine precipitation patterns at the points in the growing season when crops are most vulnerable. Or we could investigate local environmental conditions only for time periods surrounding each child’s birth.</p>
<p>Furthermore, our CHIRPS data span until the end of 2010, but the health interview responses come from <em>before</em> the end of 2010, meaning that some of our rainfall data can’t possibly be causally linked to the health responses.</p>
<p>Using geographic data therefore requires careful planning and thought. Nonetheless, the workflow and methods introduced in this post should give you a solid foundation from which to start thinking about how to integrate spatial data into analyses of IPUMS DHS data.</p>
</section><div id="quarto-appendix" class="default"><section id="getting-help" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Getting Help</h2><div class="quarto-appendix-contents">
<p>Questions or comments? Check out the <a href="https://forum.ipums.org">IPUMS User Forum</a> or reach out to IPUMS User Support at ipums@umn.edu.</p>



</div></section><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Mirza2011" class="csl-entry" role="listitem">
1. Mirza, M. M. Q. (2011). Climate change, flooding in <span>S</span>outh <span>A</span>sia and implications. <em>Regional Environmental Change</em>, <em>11</em>, 95–107. <a href="https://doi.org/10.1007/S10113-010-0184-7">https://doi.org/10.1007/S10113-010-0184-7</a>
</div>
<div id="ref-Martens1997" class="csl-entry" role="listitem">
2. Martens, W. J. M., Jetten, T. H., &amp; Focks, D. A. (1997). Sensitivity of malaria, schistosomiasis and dengue to global warming. <em>Climatic Change</em>, <em>35</em>, 145–156. <a href="https://doi.org/10.1023/A:1005365413932">https://doi.org/10.1023/A:1005365413932</a>
</div>
<div id="ref-Lesk2016" class="csl-entry" role="listitem">
3. Lesk, C., Rowhani, P., &amp; Ramankutty, N. (2016). Influence of extreme weather disasters on global crop production. <em>Nature</em>, <em>529</em>, 84–87. <a href="https://doi.org/10.1038/nature16467">https://doi.org/10.1038/nature16467</a>
</div>
<div id="ref-Minn" class="csl-entry" role="listitem">
4. Minn, M. (n.d.). <em>Points vs. <span class="nocase">l</span>ines vs. <span class="nocase">p</span>olygons</em>. <a href="https://michaelminn.net/tutorials/arcgis-pro-terrain/">https://michaelminn.net/tutorials/arcgis-pro-terrain/</a>
</div>
<div id="ref-Funk2015" class="csl-entry" role="listitem">
5. Funk, C., Peterson, P., Landsfeld, M., Pedreros, D., Verdin, J., Shukla, S., Husak, G., Rowland, J., Harrison, L., Hoell, A., &amp; Michaelsen, J. (2015). The climate hazards infrared precipitation with stations—a new environmental record for monitoring extremes. <em>Scientific Data</em>, <em>2</em>, 1–21. <a href="https://doi.org/10.1038/sdata.2015.66">https://doi.org/10.1038/sdata.2015.66</a>
</div>
<div id="ref-Pena-Guerrero2022" class="csl-entry" role="listitem">
6. Peña-Guerrero, M. D., Umirbekov, A., Tarasova, L., &amp; Müller, D. (2022). Comparing the performance of high-resolution global precipitation products across topographic and climatic gradients of <span>C</span>entral <span>A</span>sia. <em>International Journal of Climatology</em>, <em>42</em>, 5554–5569. <a href="https://doi.org/10.1002/JOC.7548">https://doi.org/10.1002/JOC.7548</a>
</div>
<div id="ref-Pyarali2022" class="csl-entry" role="listitem">
7. Pyarali, K., Peng, J., Disse, M., &amp; Tuo, Y. (2022). Development and application of high resolution SPEI drought dataset for <span>C</span>entral <span>A</span>sia. <em>Scientific Data</em>, <em>9</em>, 1–14. <a href="https://doi.org/10.1038/s41597-022-01279-5">https://doi.org/10.1038/s41597-022-01279-5</a>
</div>
</div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ipums\.github\.io\/dhs-research-hub");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Developed by <a href="https://www.ipums.org">IPUMS</a> at the University of Minnesota<br>Licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License Version 2.0</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>