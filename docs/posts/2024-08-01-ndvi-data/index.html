<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Finn Roberts">
<meta name="dcterms.date" content="2024-08-01">
<meta name="description" content="Use purrr and terra to efficiently integrate NDVI data across multiple spatial extents">
<title>IPUMS DHS Climate Change and Health Research Hub - An Iterative Workflow for Loading NDVI Data in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon/favicon-32x32.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0WLH5S9VD5"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0WLH5S9VD5', { 'anonymize_ip': true});
</script>
<meta property="og:title" content="IPUMS DHS Research Hub — An Iterative Workflow for Loading NDVI Data in R">
<meta property="og:description" content="Use purrr and terra to efficiently integrate NDVI data across multiple spatial extents">
<meta property="og:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-08-01-ndvi-data/index_files/figure-html/listing-img-1.png">
<meta property="og:site_name" content="IPUMS DHS Climate Change and Health Research Hub">
<meta property="og:image:height" content="1536">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="IPUMS DHS Research Hub — An Iterative Workflow for Loading NDVI Data in R">
<meta name="twitter:description" content="Use purrr and terra to efficiently integrate NDVI data across multiple spatial extents">
<meta name="twitter:image" content="https://ipums.github.io/dhs-research-hub/posts/2024-08-01-ndvi-data/index_files/figure-html/listing-img-1.png">
<meta name="twitter:image-height" content="1536">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://www.idhsdata.org/idhs/" class="navbar-brand navbar-brand-logo">
    <img src="../../images/dhs_logo_white.png" alt="" class="navbar-logo"></a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Climate Change and Health Research Hub</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-getting-started" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Getting Started</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-getting-started">
<li>
    <a class="dropdown-item" href="../../posts/2024-02-01-getting-started-with-r/index.html">
 <span class="dropdown-text">An Introduction to R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/2024-02-02-download-dhs-data/index.html">
 <span class="dropdown-text">Obtaining IPUMS DHS Data</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-community" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Community</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-community">
<li>
    <a class="dropdown-item" href="https://forum.ipums.org">
 <span class="dropdown-text">IPUMS Forum</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../CODE_OF_CONDUCT.html">
 <span class="dropdown-text">Code of Conduct</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../LICENSE.html">
 <span class="dropdown-text">License</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/ipums/dhs-research-hub"> 
<span class="menu-text"><i class="fa-brands fa-github" aria-label="github"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml"> 
<span class="menu-text"><i class="fa-solid fa-rss" aria-label="rss"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://twitter.com/ipumsGH"> 
<span class="menu-text"><i class="fa-brands fa-x-twitter" aria-label="x-twitter"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://forum.ipums.org"> 
<span class="menu-text"><i class="fa-solid fa-users" aria-label="users"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.ipums.org/"> 
<span class="menu-text"><i class="fa-solid fa-globe" aria-label="globe"></i></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">An Iterative Workflow for Loading NDVI Data in R</h1>
                  <div>
        <div class="description">
          Use purrr and terra to efficiently integrate NDVI data across multiple spatial extents
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">NDVI</div>
                <div class="quarto-category">Agriculture</div>
                <div class="quarto-category">Climate</div>
                <div class="quarto-category">Food production</div>
                <div class="quarto-category">Importing Data</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Reproducible workflows</div>
                <div class="quarto-category">Time series</div>
                <div class="quarto-category">stringr</div>
                <div class="quarto-category">purrr</div>
                <div class="quarto-category">terra</div>
                <div class="quarto-category">ggspatial</div>
                <div class="quarto-category">sf</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Finn Roberts </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              IPUMS Senior Data Analyst
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 1, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#ndvi-vs.-other-climate-data-sources" id="toc-ndvi-vs.-other-climate-data-sources" class="nav-link active" data-scroll-target="#ndvi-vs.-other-climate-data-sources">NDVI vs.&nbsp;other climate data sources</a></li>
  <li>
<a href="#obtaining-ndvi-data" id="toc-obtaining-ndvi-data" class="nav-link" data-scroll-target="#obtaining-ndvi-data">Obtaining NDVI Data</a>
  <ul class="collapse">
<li>
<a href="#earthdata-search" id="toc-earthdata-search" class="nav-link" data-scroll-target="#earthdata-search">Earthdata Search</a>
  <ul class="collapse">
<li><a href="#find-data" id="toc-find-data" class="nav-link" data-scroll-target="#find-data">Find data</a></li>
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download">Download</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#preparing-ndvi-data" id="toc-preparing-ndvi-data" class="nav-link" data-scroll-target="#preparing-ndvi-data">Preparing NDVI data</a>
  <ul class="collapse">
<li><a href="#nasa-image-files" id="toc-nasa-image-files" class="nav-link" data-scroll-target="#nasa-image-files">NASA image files</a></li>
  <li><a href="#regular-expressions" id="toc-regular-expressions" class="nav-link" data-scroll-target="#regular-expressions">Regular expressions</a></li>
  <li>
<a href="#an-iterative-r-workflow" id="toc-an-iterative-r-workflow" class="nav-link" data-scroll-target="#an-iterative-r-workflow">An iterative R workflow</a>
  <ul class="collapse">
<li><a href="#the-purrr-package" id="toc-the-purrr-package" class="nav-link" data-scroll-target="#the-purrr-package">The purrr package</a></li>
  </ul>
</li>
  <li><a href="#crop-tiles" id="toc-crop-tiles" class="nav-link" data-scroll-target="#crop-tiles">Crop tiles</a></li>
  <li><a href="#mosaic-tiles" id="toc-mosaic-tiles" class="nav-link" data-scroll-target="#mosaic-tiles">Mosaic tiles</a></li>
  </ul>
</li>
  <li>
<a href="#up-next" id="toc-up-next" class="nav-link" data-scroll-target="#up-next">Up next</a>
  <ul class="collapse">

  </ul>
</li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>In our <a href="../2024-07-02-ndvi-concepts">previous post</a>, we introduced NDVI as a remote sensing tool that can be used to study the effects of climate conditions on malnourishment and other health outcomes. In this post, we’ll show how to access and load NDVI data using R.</p>
<section id="ndvi-vs.-other-climate-data-sources" class="level1"><h1>NDVI vs.&nbsp;other climate data sources</h1>
<p>Like the other climate metrics we’ve used on this blog (<a href="../2024-02-04-dhs-chirps">CHIRPS</a> and <a href="../2024-04-15-chirts-metrics">CHIRTS</a>), NDVI data are also provided in raster format. However, there are some key differences.</p>
<ol type="1">
<li><p>First, NDVI is a <em>calculated value</em>, whereas our previous climate metrics were <em>modeled values</em>. That is, NDVI is calculated directly from the reflectance of different light wavelengths as measured via satellite. In contrast, CHIRPS and CHIRTS integrate ground-level station data with satellite observations to create a <strong>model</strong> of rainfall and temperature across the surface.</p></li>
<li><p>NDVI is also provided at higher resolutions than CHIRPS or CHIRTS. For population health research, this resolution typically exceeds what is useful since we will be linking NDVI data to survey data that has far more geographic uncertainty. Still, this difference can introduce new challenges as NDVI raster files can be much larger than the files for the other metrics we have worked with so far.</p></li>
<li><p>Depending on the data source, NDVI data may be distributed for specific spatial extents and at multi-week time intervals. Whereas daily time series of CHIRPS and CHIRTS could be downloaded for large spatial extents and cropped to an area of interest, NDVI often requires more manual work to integrate data from different spatial extents and time intervals.</p></li>
</ol>
<p>This post will primarily focus on this last point. We’ll demonstrate some of the additional steps required to produce a usable NDVI time series for a particular area of interest. In the process, we’ll introduce new R techniques that can assist in this workflow.</p>
</section><section id="obtaining-ndvi-data" class="level1 page-columns page-full"><h1>Obtaining NDVI Data</h1>
<p>Not only are there multiple sources that provide NDVI data, there are also multiple satellites that collect the images used to calculate NDVI. For this post, we’ll use data from NASA’s <a href="https://terra.nasa.gov/about/terra-instruments/modis">MODIS</a> satellite, which provides data at a 250 meter resolution.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>While this resolution exceeds our typical needs, we use 250 meter data for this post and the next to help demonstrate some of the relevant considerations for working with NDVI data in a population health context.</p>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MODIS Retirement
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remote sensing instruments exist in a constant state of evolution as satellites are launched and retired. This means that researchers relying on remotely sensed data—like NDVI—often need to develop fluency with multiple data products that may cover different time periods, spatial ranges, or provide different types of imaging data.</p>
<p>In fact, NASA’s Terra satellite—which houses MODIS instruments—will be retired in the near future. Because of this, many researchers now use NASA’s <a href="https://www.earthdata.nasa.gov/sensors/viirs">VIIRS</a> product to obtain NDVI data.</p>
<p>We’re still using MODIS for the demonstrations in this post because these data are widely familiar and may still be valuable for certain time periods before newer products became available.</p>
<p>In the future, we hope to release more posts highlighting additional data products!</p>
</div>
</div>
<section id="earthdata-search" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="earthdata-search">Earthdata Search</h2>
<p>We’ll use NASA’s Earthdata Search web interface to select and download data. Earthdata Search provides access to NASA’s immense archive of satellite data.</p>
<p>Before you can access MODIS register for access to Earthdata Search, you’ll need to <a href="https://urs.earthdata.nasa.gov/home">register</a> for a free account.</p>
<section id="find-data" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="find-data">Find data</h3>
<p>Once you’ve registered for an account, you can open up the <a href="https://search.earthdata.nasa.gov/search">Earthdata Search interface</a>, which should look something like this:</p>
<div class="column-page">
<p><img src="images/ed_search.png" class="img-fluid"></p>
</div>
<p>From this interface, you can search for data across many NASA products.</p>
<section id="selecting-a-product" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="selecting-a-product">Selecting a product</h4>
<p>As mentioned above, we’ll use data from MODIS for this post. MODIS provides several different <a href="https://modis.gsfc.nasa.gov/data/dataprod/mod13.php">NDVI products</a> that vary in their temporal and spatial resolution. Each product has a specific code used to reference it (see the previous link for a table including these codes).</p>
<p>Some products are provided at the monthly level. If you don’t need finer temporal resolution, it’s preferable to download the monthly data provided directly by NASA. This is because NASA performs additional quality assurance steps when producing monthly data, including adding corrections for pixels obscured due to cloud cover and other similar tweaks. NASA’s processing will generally be better than any preprocessing we would do on our own.</p>
<p>Of course, for more finely-tuned temporal analyses (e.g.&nbsp;start-of-season analyses), it may be more appropriate to download data from one of the 16-day MODIS products.</p>
<p>Either way, you can search for a particular product by typing its code in the search bar in the top left of the Earthdata Search interface, as shown below.</p>
<div class="column-page">
<p><img src="images/ed_search_mod13q1.png" class="img-fluid"></p>
</div>
<p>In our case, we’ve selected the MOD13Q1 product, which provides data at a 250 meter resolution in 16-day increments.</p>
<p>You can also select a geographic region of interest using the polygon drawing tools on the right side of the screen. For instance, to identify data for Kenya, we can draw a polygon around the country. Selecting a region will highlight the different areas, or <em>tiles</em>, for which we can download data.</p>
<p>In the case of Kenya, the country spans 4 different MODIS tiles. To obtain full coverage of the entire country, we’ll need to download each tile and stich them together.</p>
<div class="column-page">
<p><img src="images/ed_search_ke_bbox.png" class="img-fluid"></p>
</div>
<p>To narrow down further, you can filter the time range of data by entering start and end dates on the left side of the interface.</p>
<p>Once you’ve selected the area and time of interest, you can click the <strong>Download</strong> button to proceed to the download page, as shown below.</p>
<div class="column-page">
<p><img src="images/ed_search_time.png" class="img-fluid"></p>
</div>
</section></section><section id="download" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="download">Download</h3>
<p>Depending on how many tiles and time increments you’ll be downloading, you’ll notice that the estimated data storage size will be quite large. This is both a product of the resolution of this data as well as the fact that we must download full tiles of data. That is, we can’t download data just for our region of interest alone; instead, we have to download data for the MODIS tile(s) that contain that region and then crop the resulting data.</p>
<section id="data-storage-concerns" class="level4"><h4 class="anchored" data-anchor-id="data-storage-concerns">Data storage concerns</h4>
<p>Data storage can therefore be a significant barrier with working with long time series of NDVI data. This is why most institutions and researchers who work extensively with raster data have dedicated server space to use when running raster operations.</p>
<p>However, if your area of interest is small enough, it may be possible to build up a dataset by downloading and cropping data to that area incrementally, preventing you from needing to store large image files indefinitely.</p>
<p>There are also cloud-based solutions available, <a href="https://earthengine.google.com/">Google Earth Engine</a> and <a href="https://aws.amazon.com/earth/">Amazon Web Services</a>. Google Earth Engine in particular has become a popular interface that combines an interactive map and documentation with a JavaScript library that allows you to write scripts for geoprocessing on Google’s servers. We won’t discuss these options extensively here, but if you begin working on more data-intensive spatial projects, it may be worth exploring what they have to offer.</p>
</section><section id="downloaded-files" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="downloaded-files">Downloaded files</h4>
<p>After clicking the <strong>Download</strong> link, you should be redirected to a download page that shows the individual files that fit your selection criteria. The page will also include a <code>download.sh</code> script that will perform a batch download. This can be useful if you’re downloading data for many files at once. See the <a href="https://wiki.earthdata.nasa.gov/display/EDSC/How+To%3A+Use+the+Download+Access+Script">Earthdata documentation</a> for more details on how to use this script to automate the download of many files.</p>
<p>You’ll get a separate HDF file for each tile and time increment. Fortunately, <a href="https://rspatial.org/">terra</a> is able to load HDF files, so we don’t need to learn any new R tools yet. However, because each tile represents a <em>different</em> spatial extent, we need to use a new technique to combine them into a single source, called a <strong>mosaic</strong>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://rspatial.github.io/terra/index.html" class="hex"> <img src="../../images/hex/terra.png" class="hex-img"></a> <p class="hex-cap">© Robert J. Hijmans et al. (GPL &gt;=3)</p> </div>
</div></div></section></section></section></section><section id="preparing-ndvi-data" class="level1 page-columns page-full"><h1>Preparing NDVI data</h1>
<p>Now that we have our data downloaded, we’ll shift our focus to loading those data into R. For this demonstration, we’ve downloaded data for the 4 tiles that cover the entirety of Kenya for 2 time intervals in 2014. That is, we have 8 total files downloaded.</p>
<p>In practice, you’d likely include a longer time series; we’ve opted to use only 2 dates to limit the processing time required for this demo. Regardless, we will demonstrate a workflow that can be easily scaled to load more files.</p>
<p>Before getting started, we’ll load some of the familiar packages that have been introduced previously on the blog:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="nasa-image-files" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="nasa-image-files">NASA image files</h2>
<p>NASA provides its files in HDF format. Each HDF file is identified by its tile code (e.g.&nbsp;<code>h21v08</code>) and its timestamp code (e.g.&nbsp;<code>A2014001</code>). To mosaic our tiles, we’ll need to create a separate raster stack for each tile across all of our timestamps.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>HDF stands for Hierarchical Data Format, yet another common raster data file format.</p>
</div></div><p>First, we’ll list all our files, which we’ve saved in a directory we’ve named <code>data_local/MOD13Q1</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"data_local/MOD13Q1"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll notice that each file contains the tile code and timestamp in the file name.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">files</span></span>
<span><span class="co">#&gt; [1] "data_local/MOD13Q1/MOD13Q1.A2014001.h21v08.061.2021246163834.hdf"</span></span>
<span><span class="co">#&gt; [2] "data_local/MOD13Q1/MOD13Q1.A2014001.h21v09.061.2021246163703.hdf"</span></span>
<span><span class="co">#&gt; [3] "data_local/MOD13Q1/MOD13Q1.A2014001.h22v08.061.2021246164307.hdf"</span></span>
<span><span class="co">#&gt; [4] "data_local/MOD13Q1/MOD13Q1.A2014001.h22v09.061.2021246155251.hdf"</span></span>
<span><span class="co">#&gt; [5] "data_local/MOD13Q1/MOD13Q1.A2014209.h21v08.061.2021260011612.hdf"</span></span>
<span><span class="co">#&gt; [6] "data_local/MOD13Q1/MOD13Q1.A2014209.h21v09.061.2021260011337.hdf"</span></span>
<span><span class="co">#&gt; [7] "data_local/MOD13Q1/MOD13Q1.A2014209.h22v08.061.2021260023343.hdf"</span></span>
<span><span class="co">#&gt; [8] "data_local/MOD13Q1/MOD13Q1.A2014209.h22v09.061.2021260023455.hdf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ultimately, we’ll need to group each of these files such that we can create a single raster stack for each <strong>tile</strong>. The layers in that stack should correspond to the data’s <strong>timestamps</strong>. This will produce a time series of NDVI data for each spatial region which can later be combined with the adjacent regions.</p>
<p>To achieve this, we’ll need to leverage the tile and timestamp codes that NASA provides in its file names.</p>
</section><section id="regular-expressions" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="regular-expressions">Regular expressions</h2>
<p>Right now, all our files are in one large list. But because they represent different spatial extents, we can’t load them all at once with terra:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: [rast] extents do not match</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead, we need to first organize our files by their tile codes. We could go ahead and manually store the codes for later access like so:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tile_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"h21v08"</span>, <span class="st">"h21v09"</span>, <span class="st">"h22v08"</span>, <span class="st">"h22v09"</span><span class="op">)</span></span>
<span><span class="va">timestamps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2014001"</span>, <span class="st">"2014209"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, this wouldn’t produce a very flexible workflow: if we ever decided to perform a similar analysis for different times or spatial regions, we’d have to modify these codes manually.</p>
<p>An alternative approach would be to dynamically extract the codes using <strong>regular expressions</strong>. The term <em>regular expressions</em> refers to a specific syntax designed to identify and extract sequences of characters in a set of text.</p>
<p>We’ll use the <a href="https://stringr.tidyverse.org">stringr</a> package to demonstrate the basics of regular expressions:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://stringr.tidyverse.org/index.html" class="hex"> <img src="../../images/hex/stringr.png" class="hex-img"></a> <p class="hex-cap">© RStudio, Inc. (MIT)</p> </div>
</div></div><p>At their simplest, regular expressions allow you to extract specific characters from a string:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># str_detect() tells us whether a search pattern exists in the target string</span></span>
<span></span>
<span><span class="co"># "b" does exist in the string</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># "z" does not exist in the string:</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"z"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, regular expressions may also include special characters, which allow you to search more flexibly. For instance, <code>[</code> brackets allow us to define a <em>character class</em>, which will detect whether any of the enclosed characters is present.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"[ahz]"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use a similar approach to search for any numeric digits in our string:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"[0-9]"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Curly braces can be used to detect a certain number of sequential characters. For instance, to determine whether the string contains 3 consecutive digits:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"[0-9]{3}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This returns <code>TRUE</code>, but if we searched for a longer sequence, we’d no longer be able to detect a match for the pattern:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"[0-9]{4}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The special characters <code>^</code> and <code>$</code> represent the start and end of the string, respectively. For instance, to determine if the string starts with a digit:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"^[0-9]"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or to determine if it ends with a digit:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="st">"abc123"</span>, <span class="st">"[0-9]$"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are far more <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_expressions/Cheatsheet">available options</a> in the regular expression language, and we won’t be able to cover them all here. The stringr package includes a helpful <a href="https://stringr.tidyverse.org/articles/regular-expressions.html?q=:digit:#matching-multiple-characters">introduction</a> to help you get started.</p>
<p>In our case, we can use the basic syntax we just introduced to extract the tile code from our file names:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract h00v00 tile code pattern</span></span>
<span><span class="va">tile_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">files</span>, <span class="st">"h[0-9]{2}v[0-9]{2}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tile_codes</span></span>
<span><span class="co">#&gt; [1] "h21v08" "h21v09" "h22v08" "h22v09"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Importantly, if we ever download new files for different tiles, this code will <em>still extract their tile codes</em> without any modification (that is, unless NASA changes their file naming conventions unexpectedly).</p>
<p>Regular expressions therefore allow us to implement a <strong>generalized</strong> approach that is more robust to future changes in our analysis.</p>
</section><section id="an-iterative-r-workflow" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="an-iterative-r-workflow">An iterative R workflow</h2>
<p>Next, we need to group the files so that all files for a single tile are placed together. That way, all the timestamps for each tile will be loaded into a raster stack with a single spatial extent. Each layer will correspond to a different timestamp.</p>
<p>Because we have multiple tiles and multiple files for each tile, we will likely need to apply the same set of processing operations many times over. While we could copy and paste our code to group each tile’s files, this would quickly become tedious. Furthermore, hard-coding our file groups would make it harder to make modifications if we were to add more files to our analysis or adapt our code to work with a different region.</p>
<p>Instead, we can build an <em>iterative</em> workflow that will automatically apply our processing steps for each tile.</p>
<section id="the-purrr-package" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="the-purrr-package">The purrr package</h3>
<p>We’ll use the <a href="https://purrr.tidyverse.org/">purrr</a> package to build our workflow. The purrr package provides a concise syntax for iterating through multiple inputs. This is primarily facilitated by purrr’s <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> function.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://purrr.tidyverse.org/index.html" class="hex"> <img src="../../images/hex/purrr.png" class="hex-img"></a> <p class="hex-cap">© RStudio, Inc. (GPL-3)</p> </div>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Iterating in base R
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may already be familiar with the <code>for</code> loop or with <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>, both of which are options for iterating in base R (<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> is most similar to purrr’s <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>).</p>
<p>If you’re more comfortable with these tools, the code we introduce below can certainly be adapted for a <code>for</code> loop or <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> workflow.</p>
</div>
</div>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> allows us to iterate by providing two things:</p>
<ul>
<li>The list (or vector) of objects we want to iterate over</li>
<li>A function describing the operation we want to do for each element in the list</li>
</ul>
<p>For instance, take this list of letters:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span><span class="op">)</span>, </span>
<span>  <span class="st">"F"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">l</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "A" "B"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "C" "D" "E"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] "F"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s say we want to find out the length of each element in our list. Many R functions are vectorized, so we might think to simply use <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> on our list:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Vectorized functions automatically operate on each individual element of a vector. For instance, <code><a href="https://rdrr.io/r/base/nchar.html">nchar()</a></code> can count characters in a single string or for each string in a vector of strings.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, this gives us the length of our <em>input</em> list <code>l</code>, which isn’t what we want. Instead, we can use purrr to <strong>map</strong> the <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> function to each element in our list <code>l</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each element in `l`, apply the `length()` function</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Anonymous function syntax
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can also provide the function in R’s anonymous function syntax, which we introduced <a href="../2024-04-15-chirts-metrics/index.html#scaling-up">previously</a>. For instance:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">l</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or, for R 4.1+</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">l</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to modify other arguments of the function being mapped, you’ll need to use anonymous function syntax instead of the function name itself.</p>
</div>
</div>
<p>We see that <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> returns a <strong>list</strong> containing the result we get when we apply the <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> function to each individual element in <code>l</code>.</p>
<p>We can do a similar process with our raster tiles. For each tile code, we want to detect the files that contain that tile code in their name. This way, we can group those files together.</p>
<p>Here, we use <code><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect()</a></code> to detect the presence of the input <code>tile_code</code> string in our set of files. For each tile code, we’ll get a set of logical values indicating the position of the files that contain that code.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># For each tile code, identify the file indexes that contain that code</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">tile_codes</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">code</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use these logical values to subset the file names that correspond to each tile code. Remember that we’ll have multiple files for each tile because we’re working with multiple timestamps:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">tile_codes</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="va">files</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">code</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiles</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "data_local/MOD13Q1/MOD13Q1.A2014001.h21v08.061.2021246163834.hdf"</span></span>
<span><span class="co">#&gt; [2] "data_local/MOD13Q1/MOD13Q1.A2014209.h21v08.061.2021260011612.hdf"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "data_local/MOD13Q1/MOD13Q1.A2014001.h21v09.061.2021246163703.hdf"</span></span>
<span><span class="co">#&gt; [2] "data_local/MOD13Q1/MOD13Q1.A2014209.h21v09.061.2021260011337.hdf"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] "data_local/MOD13Q1/MOD13Q1.A2014001.h22v08.061.2021246164307.hdf"</span></span>
<span><span class="co">#&gt; [2] "data_local/MOD13Q1/MOD13Q1.A2014209.h22v08.061.2021260023343.hdf"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] "data_local/MOD13Q1/MOD13Q1.A2014001.h22v09.061.2021246155251.hdf"</span></span>
<span><span class="co">#&gt; [2] "data_local/MOD13Q1/MOD13Q1.A2014209.h22v09.061.2021260023455.hdf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- :::{.callout-note} -->
<!-- purrr syntax takes a little bit of getting used to, but it ultimately can make -->
<!-- it much easier to do recurring operations across a large set of inputs. -->
<!-- In the long run, learning to add iteration to your data processing workflows  -->
<!-- will save you time and make your processing scripts more robust. -->
<!-- ::: -->
<p>At this point we can load each of our tiles into a separate raster stack using terra’s <code><a href="https://rspatial.github.io/terra/reference/rast.html">rast()</a></code>. Each of these files contains several layers with different measures. We can peek at the layers by loading the first file. We’re only interested in the layer of NDVI values, which we see is the first layer:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "\"250m 16 days NDVI\""                     </span></span>
<span><span class="co">#&gt;  [2] "\"250m 16 days EVI\""                      </span></span>
<span><span class="co">#&gt;  [3] "\"250m 16 days VI Quality\""               </span></span>
<span><span class="co">#&gt;  [4] "\"250m 16 days red reflectance\""          </span></span>
<span><span class="co">#&gt;  [5] "\"250m 16 days NIR reflectance\""          </span></span>
<span><span class="co">#&gt;  [6] "\"250m 16 days blue reflectance\""         </span></span>
<span><span class="co">#&gt;  [7] "\"250m 16 days MIR reflectance\""          </span></span>
<span><span class="co">#&gt;  [8] "\"250m 16 days view zenith angle\""        </span></span>
<span><span class="co">#&gt;  [9] "\"250m 16 days sun zenith angle\""         </span></span>
<span><span class="co">#&gt; [10] "\"250m 16 days relative azimuth angle\""   </span></span>
<span><span class="co">#&gt; [11] "\"250m 16 days composite day of the year\""</span></span>
<span><span class="co">#&gt; [12] "\"250m 16 days pixel reliability\""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because data at this resolution can be memory-intensive, we can load only the layer of NDVI data by using the <code>lyrs</code> argument to <code><a href="https://rspatial.github.io/terra/reference/rast.html">rast()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lyrs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4800, 4800, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 3335852, 4447802, 0, 1111951  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source      : MOD13Q1.A2014001.h21v08.061.2021246163834.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI </span></span>
<span><span class="co">#&gt; varname     : MOD13Q1.A2014001.h21v08.061.2021246163834 </span></span>
<span><span class="co">#&gt; name        : "250m 16 days NDVI"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we’ll be loading multiple files (one for each timestamp) into each raster stack for each tile. Therefore, we have to select the first layer <em>of each raster file</em>. The <code>lyrs</code> argument considers all the files together when loading them. That is, <code>lyrs = 1</code> doesn’t refer to the first layer of <em>each</em> file. Instead, it will extract the very first layer of the first file only.</p>
<p>Fortunately, each file is organized identically, so we know that NDVI will always be the first layer. Because there are 12 layers in each file, we just need to load every 12th layer. We can easily build a sequence that contains the correct layer numbers:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Maximum layer value will be the first layer in the very last file being loaded</span></span>
<span><span class="va">max_lyrs</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tiles</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create sequence in increments of 12 up to the maximum layer index needed</span></span>
<span><span class="va">ndvi_layers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_lyrs</span>, by <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ndvi_layers</span></span>
<span><span class="co">#&gt; [1]  1 13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can again <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> over our file groups to load each set of files, selecting out only the NDVI layers:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load NDVI layers for each set of files corresponding to a particular tile</span></span>
<span><span class="va">ndvi_tiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">tiles</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">x</span>, lyrs <span class="op">=</span> <span class="va">ndvi_layers</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that we now have a list of 4 separate raster stacks, because we loaded each entry in <code>tiles</code> separately:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndvi_tiles</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4800, 4800, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 3335852, 4447802, 0, 1111951  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; sources     : MOD13Q1.A2014001.h21v08.061.2021246163834.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h21v08.061.2021260011612.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt; varnames    : MOD13Q1.A2014001.h21v08.061.2021246163834 </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h21v08.061.2021260011612 </span></span>
<span><span class="co">#&gt; names       : "250m 16 days NDVI", "250m 16 days NDVI" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4800, 4800, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 3335852, 4447802, -1111951, 0  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; sources     : MOD13Q1.A2014001.h21v09.061.2021246163703.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h21v09.061.2021260011337.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt; varnames    : MOD13Q1.A2014001.h21v09.061.2021246163703 </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h21v09.061.2021260011337 </span></span>
<span><span class="co">#&gt; names       : "250m 16 days NDVI", "250m 16 days NDVI" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4800, 4800, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 4447802, 5559753, 0, 1111951  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; sources     : MOD13Q1.A2014001.h22v08.061.2021246164307.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h22v08.061.2021260023343.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt; varnames    : MOD13Q1.A2014001.h22v08.061.2021246164307 </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h22v08.061.2021260023343 </span></span>
<span><span class="co">#&gt; names       : "250m 16 days NDVI", "250m 16 days NDVI" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4800, 4800, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 4447802, 5559753, -1111951, 0  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; sources     : MOD13Q1.A2014001.h22v09.061.2021246155251.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h22v09.061.2021260023455.hdf:MODIS_Grid_16DAY_250m_500m_VI:250m 16 days NDVI  </span></span>
<span><span class="co">#&gt; varnames    : MOD13Q1.A2014001.h22v09.061.2021246155251 </span></span>
<span><span class="co">#&gt;               MOD13Q1.A2014209.h22v09.061.2021260023455 </span></span>
<span><span class="co">#&gt; names       : "250m 16 days NDVI", "250m 16 days NDVI"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To confirm that each raster stack comes from a different tile, we note that each has a different spatial extent:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">ndvi_tiles</span>, <span class="va">ext</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; SpatExtent : 3335851.559, 4447802.078667, 0, 1111950.519667 (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; SpatExtent : 3335851.559, 4447802.078667, -1111950.519667, 0 (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; SpatExtent : 4447802.078667, 5559752.598333, 0, 1111950.519667 (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; SpatExtent : 4447802.078667, 5559752.598333, -1111950.519667, 0 (xmin, xmax, ymin, ymax)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="crop-tiles" class="level2"><h2 class="anchored" data-anchor-id="crop-tiles">Crop tiles</h2>
<p>Next, we’ll crop our tiles to our area of interest (in this case, using the Kenya national borders). This will reduce the size of our files going forward and speed up any subsequent processing.</p>
<p>To crop the tiles to our area of interest, we’ll need country borders. We’ll load the integrated boundaries from IPUMS and dissolve them (with <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code>) to get the national border.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ke_borders</span> <span class="op">&lt;-</span> <span class="fu">ipumsr</span><span class="fu">::</span><span class="fu"><a href="https://tech.popdata.org/ipumsr/reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="st">"data/geo_ke1989_2014.zip"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Fix minor border inconsistencies</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to make sure our borders are in the same coordinate system as our raster before we can crop to its extent, so we’ll extract the CRS from one of our rasters and use it with <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> to convert our borders’ CRS. (We’ve introduced <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> <a href="https://tech.popdata.org/dhs-research-hub/posts/2024-02-04-dhs-chirps/index.html#cluster-buffers">in the past</a>.)</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Raster projection
</div>
</div>
<div class="callout-body-container callout-body">
<p>In general, if you’re working with both raster and vector data, it’s best to project the vector data to match your raster data rather than the reverse.</p>
<p>Projecting a raster distorts the cells, but because rasters necessarily are represented as a uniform grid, the values in the new cells must be resampled from the original grid, as the new cell locations may overlap with multiple input cell locations. This adds an additional later of uncertainty to the data.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Obtain CRS of NDVI raster data</span></span>
<span><span class="va">ndvi_crs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">ndvi_tiles</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Transform borders to same CRS as NDVI</span></span>
<span><span class="va">ke_borders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">ke_borders</span>, crs <span class="op">=</span> <span class="va">ndvi_crs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can use our borders to crop each tile, removing the values outside of the border area. Note that we still need to use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> because our rasters are still separate elements in the <code>ndvi_tiles</code> list:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndvi_tiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">ndvi_tiles</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">ke_borders</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’re ready to join our tiles together!</p>
</section><section id="mosaic-tiles" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="mosaic-tiles">Mosaic tiles</h2>
<p>We can mosaic our cropped tiles together with terra’s <code><a href="https://rspatial.github.io/terra/reference/mosaic.html">mosaic()</a></code> function. Typically <code><a href="https://rspatial.github.io/terra/reference/mosaic.html">mosaic()</a></code> only takes two rasters.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mosaic two of our tiles together</span></span>
<span><span class="va">ndvi_mosaic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mosaic.html">mosaic</a></span><span class="op">(</span><span class="va">ndvi_tiles</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ndvi_tiles</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we need to mosaic all 4 tiles to cover Kenya in its entirety:</p>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndvi_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  pal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"#fdfbdc"</span>,</span>
<span>    <span class="st">"#f1f4b7"</span>,</span>
<span>    <span class="st">"#d3ef9f"</span>,</span>
<span>    <span class="st">"#a5da8d"</span>,</span>
<span>    <span class="st">"#6cc275"</span>,</span>
<span>    <span class="st">"#51a55b"</span>,</span>
<span>    <span class="st">"#397e43"</span>,</span>
<span>    <span class="st">"#2d673a"</span>,</span>
<span>    <span class="st">"#1d472e"</span> </span>
<span>  <span class="op">)</span>,</span>
<span>  values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ndvi_mosaic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span><span class="va">ke_borders</span>, dTolerance <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>    values <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">values</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100000000</span><span class="op">)</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"NDVI: Kenya"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"January 1-16, 2014"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"NDVI"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: NASA MOD13Q1"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We could manually mosaic all the tiles together, but purrr actually provides a more efficient solution. The <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> function allows us to collapse a set of objects stored in a list by repeatedly applying the same operation to each pair of list elements.</p>
<p>That is, <code><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce()</a></code> allows us to mosaic the first two entries in our <code>ndvi_tiles</code> list, then mosaic that output with the next entry in the list, and so on. We simply need to provide the list of our raster tiles and the function that we want to use to collapse the list. In this case, we want to <code><a href="https://rspatial.github.io/terra/reference/mosaic.html">mosaic()</a></code> the elements in the list together into a single raster output.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ke_ndvi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span><span class="op">(</span><span class="va">ndvi_tiles</span>, <span class="va">mosaic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll rescale the NDVI values, which should range from -1 to 1:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ke_ndvi</span> <span class="op">&lt;-</span> <span class="va">ke_ndvi</span> <span class="op">/</span> <span class="fl">100000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ke_ndvi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>    values <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">values</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"NDVI: Kenya"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"January 1-16, 2014"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"NDVI"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: NASA MOD13Q1"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Notice that no time information is attached to our output raster:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ke_ndvi</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The time information is stored in a <code>A0000000</code> format string in the file name. The first 4 digits after the <code>A</code> contain the data year, and the next 3 contain the day of the year.</p>
<p>We can again use a regular expression to extract the timestamps using this pattern:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract 7-digit sequence following an "A"</span></span>
<span><span class="va">timestamps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">files</span>, <span class="st">"(?&lt;=A)[0-9]{7}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">timestamps</span></span>
<span><span class="co">#&gt; [1] "2014001" "2014209"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>"(?&lt;=A)"</code> is referred to as a <em>lookbehind assertion</em>. It will match elements of a string only if they follow the text in the assertion (in this case, <code>"A"</code>). For more about assertions, check out this <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_expressions/Cheatsheet#other_assertions">cheatsheet</a>.</p>
</div></div><p>These timestamps are in year + day of year format. We can parse this format using <a href="https://lubridate.tidyverse.org">lubridate</a>, using <code>"yj"</code> format.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p></p>
<div class="hex"> <a href="https://lubridate.tidyverse.org/index.html" class="hex"> <img src="../../images/hex/lubridate.png" class="hex-img"></a> <p class="hex-cap">© Garrett Grolemund, Hadley Wickham (GPL &gt;= 2)</p> </div>
</div><div class="">
<p>Learn more about the different codes used to specify time formats <a href="https://rdrr.io/r/base/strptime.html">here</a>.</p>
</div></div>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Parse time format and attach to our output raster</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html">time</a></span><span class="op">(</span><span class="va">ke_ndvi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/parse_date_time.html">parse_date_time</a></span><span class="op">(</span><span class="va">timestamps</span>, <span class="st">"yj"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that by manually setting the time after combining our tiles together, we may miss the possibility that certain tiles may have been recorded at a different time than others. MODIS data are fairly reliable time-wise, so these files do all share the same timestamps, but when combining files, it’s always worth confirming that each raster was recorded for the expected time range.</p>
</div>
</div>
<p>Now, we finally have a full set of NDVI data for our area of interest. We have full spatial coverage for Kenya, and we’ve got our timestamps represented in distinct layers of our raster:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ke_ndvi</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 4662, 3795, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 231.6564, 231.6564  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 3769512, 4648648, -520300.2, 559681.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source      : spat_154cc19f39e4_87244.tif </span></span>
<span><span class="co">#&gt; names       : "250m 16 days NDVI", "250m 16 days NDVI" </span></span>
<span><span class="co">#&gt; min values  :             -0.2000,             -0.2000 </span></span>
<span><span class="co">#&gt; max values  :              0.9995,              0.9995 </span></span>
<span><span class="co">#&gt; time        : 2014-01-01 to 2014-07-28 UTC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full">
<details class="code-fold"><summary>Show plot code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'patchwork'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     area</span></span>
<span></span>
<span><span class="va">ke_ndvi_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html">mask</a></span><span class="op">(</span><span class="va">ke_ndvi</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">ke_borders</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ke_ndvi_mask</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ke_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>    values <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">values</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    subtitle <span class="op">=</span> <span class="st">"January 1-16, 2014"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"NDVI"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_map</span><span class="op">(</span>show_scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_base</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ke_ndvi_mask</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">ke_borders</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colors <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">pal</span>,</span>
<span>    values <span class="op">=</span> <span class="va">ndvi_pal</span><span class="op">$</span><span class="va">values</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    subtitle <span class="op">=</span> <span class="st">"July 28-August 12, 2014"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"NDVI"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_dhs_base</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Seasonal NDVI Comparison: Kenya"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: NASA MOD13Q1"</span></span>
<span>  <span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'bottom'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="index_files/figure-html/listing-img-1.png" class="img-fluid figure-img column-page" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="up-next" class="level1"><h1>Up next</h1>
<p>In this post, we’ve introduced some approaches to build generalized workflows when loading more complicated raster data structures. Using tools like regular expressions and iteration help you produce code that is robust when your data or analyses change. The up-front time investment required for learning these tools often pays off in the long run, especially if you frequently use similar data analysis approaches.</p>
<p>As we can see in our maps above, NDVI differs significantly across the year. In our next technical post, we’ll take a closer look at this idea of seasonality and consider ways we can adapt our previous work with other climate metrics to incorporate seasons more explicitly.</p>
</section><div id="quarto-appendix" class="default"><section id="getting-help" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Getting Help</h2><div class="quarto-appendix-contents">
<p>Questions or comments? Check out the <a href="https://forum.ipums.org">IPUMS User Forum</a> or reach out to IPUMS User Support at ipums@umn.edu.</p>


</div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ipums\.github\.io\/dhs-research-hub");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Developed by <a href="https://www.ipums.org">IPUMS</a> at the University of Minnesota<br>Licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License Version 2.0</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>